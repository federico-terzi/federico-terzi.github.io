<!doctype html>
<!-- 
  Hi there! Welcome to my website :)
  It seems you are interested in the source code, did you
  know that the website is open-source? See:
  https://github.com/federico-terzi/federico-terzi.github.io
-->
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Understanding CRDTs: Improving our Set (Chapter 2) - Federico Terzi - A Software Engineering Journey</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="title" name="title" content="Federico Terzi - A Software Engineering Journey"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><meta data-n-head="ssr" data-hid="description" name="description" content="In the previous article, we implemented a basic Set with support for additions and removals, as well as basic CRDT semantics. Despite working in simple cases, we also highlighted two significant limitations:"><meta data-n-head="ssr" data-hid="og:title" property="og:title" content="Understanding CRDTs: Improving our Set (Chapter 2)"><meta data-n-head="ssr" data-hid="og:description" property="og:description" content="In the previous article, we implemented a basic Set with support for additions and removals, as well as basic CRDT semantics. Despite working in simple cases, we also highlighted two significant limitations:"><meta data-n-head="ssr" data-hid="og:image" property="og:image" content="https://federicoterzi.com/social/2024-02-25-understanding-crdts-improving-our-set-chapter-2.png"><meta data-n-head="ssr" name="twitter:card" content="summary"><meta data-n-head="ssr" name="twitter:site" content="@terzi_federico"><meta data-n-head="ssr" name="twitter:title" content="Understanding CRDTs: Improving our Set (Chapter 2)"><meta data-n-head="ssr" name="twitter:description" content="In the previous article, we implemented a basic Set with support for additions and removals, as well as basic CRDT semantics. Despite working in simple cases, we also highlighted two significant limitations:"><meta data-n-head="ssr" name="twitter:image" content="https://federicoterzi.com/social/2024-02-25-understanding-crdts-improving-our-set-chapter-2.png"><link data-n-head="ssr" rel="stylesheet" href="/colors.css"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"><link data-n-head="ssr" rel="manifest" href="/site.webmanifest"><link data-n-head="ssr" rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180"><link data-n-head="ssr" rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="preload" href="/_nuxt/fd722ce.js" as="script"><link rel="preload" href="/_nuxt/17ba505.js" as="script"><link rel="preload" href="/_nuxt/4293a24.js" as="script"><link rel="preload" href="/_nuxt/cd10c32.js" as="script"><link rel="preload" href="/_nuxt/f5ea8a1.js" as="script"><style data-vue-ssr-id="c3ae2b30:0 d75bdb94:0 fa7ff0ca:0 56b15182:0 7ab12987:0 68efd426:0 4c3275e1:0 1dd63c10:0 0356ed00:0 fcd77316:0 fcd9470c:0 71a90360:0">@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(/_nuxt/fonts/inter-v7-latin-regular.33e43c3.eot);src:local(""),url(/_nuxt/fonts/inter-v7-latin-regular.33e43c3.eot?#iefix) format("embedded-opentype"),url(/_nuxt/fonts/inter-v7-latin-regular.5e6a773.woff2) format("woff2"),url(/_nuxt/fonts/inter-v7-latin-regular.cefb4aa.woff) format("woff"),url(/_nuxt/fonts/inter-v7-latin-regular.0e67589.ttf) format("truetype"),url(/_nuxt/b8db5cf5416facf0c5ec4489d0ee9bbe.svg#Inter) format("svg")}@font-face{font-family:Inter;font-style:normal;font-weight:700;font-display:swap;src:url(/_nuxt/fonts/inter-v7-latin-700.129e115.eot);src:local(""),url(/_nuxt/fonts/inter-v7-latin-700.129e115.eot?#iefix) format("embedded-opentype"),url(/_nuxt/fonts/inter-v7-latin-700.c2ceaa0.woff2) format("woff2"),url(/_nuxt/fonts/inter-v7-latin-700.7f5a89b.woff) format("woff"),url(/_nuxt/fonts/inter-v7-latin-700.6bb53f6.ttf) format("truetype"),url(/_nuxt/0a85e1f2fd11f8afbfa155c7c5ec0a12.svg#Inter) format("svg")}@font-face{font-family:"PT Serif";font-style:normal;font-weight:400;font-display:swap;src:url(/_nuxt/fonts/pt-serif-v16-latin-regular.ef9b698.eot);src:local(""),url(/_nuxt/fonts/pt-serif-v16-latin-regular.ef9b698.eot?#iefix) format("embedded-opentype"),url(/_nuxt/fonts/pt-serif-v16-latin-regular.511cda7.woff2) format("woff2"),url(/_nuxt/fonts/pt-serif-v16-latin-regular.b4f2a8d.woff) format("woff"),url(/_nuxt/fonts/pt-serif-v16-latin-regular.1602721.ttf) format("truetype"),url(/_nuxt/2b24347634a541da72419674a1818855.svg#PTSerif) format("svg")}html{--content-primary:#1a1a1a;--content-primary-inverted:#fff;--accent-primary:#c84c32;--accent-secondary:#2e4364;--accent-tertiary:#ecdbba;--accent-menu:#2e4364;--background-primary:#fff;--background-elevated:#f1f1f1;--background-semitransparent:hsla(0,0%,100%,0.7);--details:rgba(26,26,26,0.1)}html[data-theme=dark]{--content-primary:#fff;--content-primary-inverted:#1a1a1a;--accent-primary:#ef6b50;--accent-secondary:#8bb8ff;--accent-tertiary:#ecdbba;--accent-menu:#fff;--background-primary:#000;--background-elevated:#343434;--background-semitransparent:rgba(0,0,0,0.7);--details:hsla(0,0%,100%,0.1)}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}body,html{font-family:Inter,sans-serif;color:var(--content-primary);background-color:transparent;margin:0;padding:0}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.main-layout-container{max-width:1512px;margin:auto}.main-layout-content{padding-top:95px;min-height:100vh}@media (max-width:992px){.main-layout-content{padding-top:50px;max-width:100vw;overflow-x:hidden}}.container[data-v-71b3c000]{position:fixed;top:0;left:0;right:0;bottom:0;width:100%;height:100%;overflow:hidden;z-index:-10;background-color:var(--background-primary);transition:all .5s ease}.blurred[data-v-71b3c000]{filter:blur(50px);height:450px;width:450px}.animate[data-v-71b3c000]{-webkit-animation:rotate-center-data-v-71b3c000 120s linear infinite both;animation:rotate-center-data-v-71b3c000 120s linear infinite both}.red[data-v-71b3c000]{top:25vh;left:-10vw;background-color:var(--accent-primary)}.blue[data-v-71b3c000],.red[data-v-71b3c000]{position:absolute;opacity:.15}.blue[data-v-71b3c000]{top:0;right:-10vw;background-color:var(--accent-secondary)}.yellow[data-v-71b3c000]{position:absolute;top:75vh;left:40vw;background-color:var(--accent-tertiary);opacity:.4}html[data-theme=dark] .yellow[data-v-71b3c000]{opacity:.2}@media (max-width:992px){.blurred[data-v-71b3c000]{height:300px;width:300px}}@-webkit-keyframes rotate-center-data-v-71b3c000{0%{transform:rotate(0) translateX(0) translateY(0)}50%{transform:rotate(180deg) translateX(300px) translateY(300px)}to{transform:rotate(1turn) translateX(0) translateY(0)}}@keyframes rotate-center-data-v-71b3c000{0%{transform:rotate(0) translateX(0) translateY(0)}50%{transform:rotate(180deg) translateX(300px) translateY(300px)}to{transform:rotate(1turn) translateX(0) translateY(0)}}.header[data-v-47a7b6cf]{position:fixed;top:0;right:0;left:0;z-index:20;background-color:transparent;box-shadow:none;transition:all .2s ease-in-out}html:not([data-scroll="0"]) .header[data-v-47a7b6cf]{background-color:var(--background-primary);box-shadow:0 4px 43px rgba(0,0,0,.1)}.content[data-v-47a7b6cf]{display:flex;align-items:center;justify-content:space-between;padding:25px;max-width:1512px;margin:auto}.logo-link[data-v-47a7b6cf]{text-decoration:none}.details[data-v-47a7b6cf]{display:flex}.logo[data-v-47a7b6cf]{margin-right:16px}.details-text[data-v-47a7b6cf]{display:flex;flex-direction:column;justify-content:center}.name[data-v-47a7b6cf]{font-size:24px;line-height:28px;color:var(--accent-primary)}.name[data-v-47a7b6cf],.tagline[data-v-47a7b6cf]{font-weight:700;text-shadow:0 4px 4px rgba(0,0,0,.05)}.tagline[data-v-47a7b6cf]{font-size:14px;line-height:17px;opacity:.8;color:var(--content-primary)}html[data-theme=dark] .tagline[data-v-47a7b6cf]{opacity:.9}.menu-link[data-v-47a7b6cf]{position:relative;font-style:normal;font-weight:700;font-size:18px;line-height:22px;color:var(--accent-menu);margin-left:48px;text-decoration:none;transition:all .3s ease}.menu-link[data-v-47a7b6cf]:hover{color:var(--accent-primary)}.menu-link[data-v-47a7b6cf]:after{content:"";position:absolute;display:block;width:100%;height:2px;bottom:-3px;left:0;background-color:var(--accent-secondary);transform:scaleX(0);opacity:0;transition:all .3s ease}.menu-link[data-v-47a7b6cf]:hover:after{transform:scaleX(1);opacity:1;background-color:var(--accent-primary)}.open-mobile-menu[data-v-47a7b6cf]{display:none}.mobile-menu[data-v-47a7b6cf]{position:fixed;top:0;left:0;right:0;bottom:0;background-color:var(--background-semitransparent);z-index:1000;box-shadow:0 3px 18px rgba(0,0,0,.1);display:flex;flex-direction:column;justify-content:center;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);perspective:1000px}.menu-divider[data-v-47a7b6cf]{opacity:.05;border-bottom:2px solid #2e4364;margin-right:32px;margin-left:32px}.fade-enter-active[data-v-47a7b6cf],.fade-leave-active[data-v-47a7b6cf]{transition:opacity .5s}.fade-enter[data-v-47a7b6cf],.fade-leave-to[data-v-47a7b6cf]{opacity:0;-webkit-backdrop-filter:blur(0);backdrop-filter:blur(0)}@media (max-width:992px){.name[data-v-47a7b6cf]{font-size:14px;line-height:17px}.tagline[data-v-47a7b6cf]{display:none}.details-text[data-v-47a7b6cf]{opacity:0;transition:opacity .2s ease-in-out}html:not([data-scroll="0"]) .details-text[data-v-47a7b6cf]{opacity:1}.content[data-v-47a7b6cf]{padding:14px}.extended-menu[data-v-47a7b6cf]{display:none}.open-mobile-menu[data-v-47a7b6cf]{display:block;margin-right:4px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.25))}.menu-link[data-v-47a7b6cf]{text-align:center;margin-left:0;margin-top:18px;margin-bottom:18px;-webkit-animation:slide-in-bck-center-data-v-47a7b6cf .7s cubic-bezier(.25,.46,.45,.94) both;animation:slide-in-bck-center-data-v-47a7b6cf .7s cubic-bezier(.25,.46,.45,.94) both}.mobile-menu-links[data-v-47a7b6cf]{display:flex;flex-direction:column;justify-content:center;flex:1}.mobile-menu-label[data-v-47a7b6cf]{text-align:center;font-size:12px;margin-bottom:100px}}@-webkit-keyframes slide-in-bck-center-data-v-47a7b6cf{0%{transform:translateZ(600px);opacity:0}to{transform:translateZ(0);opacity:1}}@keyframes slide-in-bck-center-data-v-47a7b6cf{0%{transform:translateZ(600px);opacity:0}to{transform:translateZ(0);opacity:1}}.container[data-v-66baf38d]{position:relative;width:46px;height:46px}.f[data-v-66baf38d],.t[data-v-66baf38d]{position:absolute}.t[data-v-66baf38d]{left:-3px;top:-1px}@media (max-width:992px){.container[data-v-66baf38d],.f[data-v-66baf38d],.t[data-v-66baf38d]{height:32px;width:32px}.t[data-v-66baf38d]{left:-1px;top:0}}.post-title[data-v-c2aeccce]{font-style:normal;font-weight:700;font-size:36px;line-height:44px;color:var(--content-primary);margin-top:0;margin-bottom:6px}.post-details[data-v-c2aeccce]{font-size:14px;line-height:17px;color:var(--content-secondary);margin-bottom:34px}.post-footer[data-v-c2aeccce]{margin-top:28px}.short-page-container{max-width:700px;margin-right:auto;margin-left:auto;margin-top:30px;padding:28px}.short-page-title{margin-bottom:50px;margin-left:-8px}@media (max-width:992px){.short-page-container{margin-top:10px}}.post-footer-container[data-v-63505c64]{font-size:18px;line-height:22px;border-top:1px solid var(--details);padding-top:28px;display:flex}.post-footer-image[data-v-63505c64]{height:138px;width:138px}.post-footer-content[data-v-63505c64]{margin-left:28px}.post-footer-content p[data-v-63505c64]:first-child{margin-top:0}.red[data-v-63505c64]{color:var(--accent-primary)}.blue[data-v-63505c64],.red[data-v-63505c64]{font-weight:700}.blue[data-v-63505c64]{color:var(--accent-secondary)}a[data-v-63505c64]{text-underline-offset:2px;text-decoration-thickness:2px}@media (max-width:992px){.post-footer-container[data-v-63505c64]{align-items:center;flex-direction:column}.post-footer-content[data-v-63505c64]{margin-left:0;margin-top:28px}}.footer-container[data-v-d5d2bd86]{font-size:14px;line-height:17px;text-align:center;color:var(--accent-menu);margin-top:40px;padding-right:16px;padding-left:16px}.bold[data-v-d5d2bd86]{font-weight:700}.red[data-v-d5d2bd86]{color:var(--accent-primary)}.social-bar-container{position:fixed;left:24px;bottom:24px;background:var(--background-elevated);border:1px solid var(--details);box-sizing:border-box;box-shadow:0 3px 8px 2px rgba(0,0,0,.1);border-radius:4px;display:flex;justify-content:space-evenly;width:360px;padding-top:10px;padding-bottom:10px;transition:all .3s ease}html[data-scrolled-to-bottom=true] .social-bar-container{opacity:0;transform:translateY(100px)}.social-bar-container a{display:flex;align-items:center;filter:drop-shadow(0 4px 6px rgba(0,0,0,.25));transition:all .3s ease}.social-bar-container a:hover{transform:scale(1.2) translateY(-3px)}.social-bar-container a path{stroke:var(--accent-primary)}.social-bar-divider{border-left:1px solid var(--details)}@media (max-width:992px){.social-bar-container{left:0;right:0;bottom:0;width:100%;border-radius:0}}</style><link rel="preload" href="/_nuxt/static/1725896671/blog/understanding-crdts-improving-our-set-chapter-2/state.js" as="script"><link rel="preload" href="/_nuxt/static/1725896671/blog/understanding-crdts-improving-our-set-chapter-2/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1725896671/manifest.js" as="script">
    <script>const debounce=t=>{let c;return(...e)=>{c&&cancelAnimationFrame(c),c=requestAnimationFrame(()=>{t(...e)})}},handleScroll=()=>{document.documentElement.dataset.scroll=window.scrollY,document.documentElement.dataset.scrolledToBottom=window.innerHeight+window.scrollY>=document.body?.offsetHeight?"true":"false"};function switchTheme(e){"dark"===e?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light")}document.addEventListener("scroll",debounce(handleScroll),{passive:!0}),handleScroll();const prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)");prefersDarkScheme.matches&&switchTheme("dark"),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>e.matches?switchTheme("dark"):switchTheme("light"))</script>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="main-layout-container"><div class="container" data-v-71b3c000><div class="blurred red animate" data-v-71b3c000></div> <div class="blurred yellow animate" data-v-71b3c000></div> <div class="blurred blue animate" data-v-71b3c000></div></div> <div id="header" class="header" data-v-47a7b6cf><div class="content" data-v-47a7b6cf><a href="/" class="logo-link nuxt-link-active" data-v-47a7b6cf><div class="details" data-v-47a7b6cf><div class="container logo" data-v-66baf38d data-v-47a7b6cf><svg width="51" height="47" viewBox="0 0 51 47" fill="none" xmlns="http://www.w3.org/2000/svg" class="f" data-v-66baf38d data-v-66baf38d><g filter="url(#filter0_d_15_34)" data-v-66baf38d data-v-66baf38d><path d="M2.09039 44.1666V2H48L2.09039 44.1666Z" fill="#C84C32" data-v-66baf38d data-v-66baf38d></path></g><defs data-v-66baf38d data-v-66baf38d><filter id="filter0_d_15_34" x="0.0543151" y="0.506876" width="49.9818" height="46.2388" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB" data-v-66baf38d data-v-66baf38d><feFlood flood-opacity="0" result="BackgroundImageFix" data-v-66baf38d data-v-66baf38d></feFlood><feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" data-v-66baf38d data-v-66baf38d></feColorMatrix><feOffset dy="0.542954" data-v-66baf38d data-v-66baf38d></feOffset><feGaussianBlur stdDeviation="1.01804" data-v-66baf38d data-v-66baf38d></feGaussianBlur><feComposite in2="hardAlpha" operator="out" data-v-66baf38d data-v-66baf38d></feComposite><feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" data-v-66baf38d data-v-66baf38d></feColorMatrix><feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_15_34" data-v-66baf38d data-v-66baf38d></feBlend><feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_15_34" result="shape" data-v-66baf38d data-v-66baf38d></feBlend></filter></defs></svg> <svg width="53" height="49" viewBox="0 0 53 49" fill="none" xmlns="http://www.w3.org/2000/svg" class="t" data-v-66baf38d data-v-66baf38d><g filter="url(#filter0_d_15_35)" data-v-66baf38d data-v-66baf38d><path d="M28.0452 45.0836L5 3H51L28.0452 45.0836Z" fill="url(#paint0_linear_15_35)" data-v-66baf38d data-v-66baf38d></path></g><defs data-v-66baf38d data-v-66baf38d><filter id="filter0_d_15_35" x="0.656367" y="0.556706" width="51.9725" height="48.0561" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB" data-v-66baf38d data-v-66baf38d><feFlood flood-opacity="0" result="BackgroundImageFix" data-v-66baf38d data-v-66baf38d></feFlood><feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" data-v-66baf38d data-v-66baf38d></feColorMatrix><feOffset dx="-1.35739" dy="0.542954" data-v-66baf38d data-v-66baf38d></feOffset><feGaussianBlur stdDeviation="1.49312" data-v-66baf38d data-v-66baf38d></feGaussianBlur><feComposite in2="hardAlpha" operator="out" data-v-66baf38d data-v-66baf38d></feComposite><feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0" data-v-66baf38d data-v-66baf38d></feColorMatrix><feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_15_35" data-v-66baf38d data-v-66baf38d></feBlend><feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_15_35" result="shape" data-v-66baf38d data-v-66baf38d></feBlend></filter><linearGradient id="paint0_linear_15_35" x1="28" y1="3" x2="28" y2="45.0836" gradientUnits="userSpaceOnUse" data-v-66baf38d data-v-66baf38d><stop stop-color="#ECDBBA" stop-opacity="0.49" data-v-66baf38d data-v-66baf38d></stop><stop offset="1" stop-color="#ECDBBA" data-v-66baf38d data-v-66baf38d></stop></linearGradient></defs></svg></div> <div class="details-text" data-v-47a7b6cf><span class="name" data-v-47a7b6cf>Federico Terzi</span> <span class="tagline" data-v-47a7b6cf>A Software Engineering Journey</span></div></div></a> <div class="extended-menu" data-v-47a7b6cf><a href="/#about" class="menu-link" data-v-47a7b6cf>About</a><a href="/projects" class="menu-link" data-v-47a7b6cf>Projects</a><a href="/blog" class="menu-link nuxt-link-active" data-v-47a7b6cf>Blog</a><a href="/talks" class="menu-link" data-v-47a7b6cf>Talks</a><a href="/contact-me" class="menu-link" data-v-47a7b6cf>Contact me</a></div> <div class="open-mobile-menu" data-v-47a7b6cf><svg width="26" height="18" viewBox="0 0 26 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-icon" data-v-47a7b6cf data-v-47a7b6cf><path d="M2 9.25H23.75" stroke="#C84C32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" data-v-47a7b6cf data-v-47a7b6cf></path><path d="M2 2H23.75" stroke="#C84C32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" data-v-47a7b6cf data-v-47a7b6cf></path><path d="M2 16.5H23.75" stroke="#C84C32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" data-v-47a7b6cf data-v-47a7b6cf></path></svg></div> <!----></div></div> <div class="main-layout-content"><article data-v-c2aeccce><div class="short-page-container" data-v-c2aeccce><!----> <h1 class="post-title" data-v-c2aeccce>Understanding CRDTs: Improving our Set (Chapter 2)</h1> <p class="post-details" data-v-c2aeccce>
      February 25th, 2024 - by Federico Terzi
    </p> <div class="post-content adaptive-images" data-v-c2aeccce><div class="nuxt-content" data-v-c2aeccce><blockquote data-v-c2aeccce>
<p data-v-c2aeccce>Welcome to <em data-v-c2aeccce>Understanding CRDTs</em>, a series of articles in which we’ll discuss CRDTs from the ground up. We’ll start from the basic concepts, trying to discuss different algorithms and data structures using simple JavaScript implementations, and we’ll gradually work towards a high-performance, JSON CRDT implementation written in Rust.</p>
<p data-v-c2aeccce>Chapters (so far):</p>
<ol data-v-c2aeccce>
<li data-v-c2aeccce><a href="/blog/understanding-crdts-a-gentle-introduction-chapter-1" data-v-c2aeccce>A Gentle Introduction</a></li>
<li data-v-c2aeccce><a href="/blog/understanding-crdts-improving-our-set-chapter-2" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-c2aeccce>Improving our Set</a></li>
</ol>
</blockquote></div> <div class="nuxt-content" data-v-c2aeccce><p data-v-c2aeccce>In the <a href="/blog/understanding-crdts-a-gentle-introduction-chapter-1" data-v-c2aeccce>previous article</a>, we implemented a basic Set with support for additions and removals, as well as basic CRDT semantics. Despite working in simple cases, we also highlighted two significant limitations:</p>

<ol data-v-c2aeccce>
<li data-v-c2aeccce>An element cannot be re-added to the Set after being removed</li>
<li data-v-c2aeccce>Although a removal would <em data-v-c2aeccce>logically</em> remove an element from the Set, the underlying data structure’s size keeps increasing over time. If we perform many deletions, this could bloat the size of the structure significantly.</li>
</ol>
<p data-v-c2aeccce>In this article, we’ll try to tackle the first problem, discussing different approaches and tradeoffs.</p>
<h1 id="supporting-additions-after-removals" data-v-c2aeccce><a href="#supporting-additions-after-removals" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Supporting additions after removals</h1>
<p data-v-c2aeccce>As we mentioned, our current Set implementation does not allow an element to be restored after being deleted:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token keyword" data-v-c2aeccce>const</span> replicaA <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>

<span class="token keyword" data-v-c2aeccce>const</span> replicaB <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

<span class="token comment" data-v-c2aeccce>// Add 'a' back</span>
replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false! Ouch, it should be true</span>
</code></pre></div>
<p data-v-c2aeccce>For some use cases, this is a significant limitation: imaging building a grocery list application. You might add some elements to your “to buy” set, and later remove them after the purchase. This would work for a while, but then you might find yourself needing to buy the same product again. In this case, you would need to add elements to the set again after deleting them.</p>
<p data-v-c2aeccce>The reason why we are unable to add an element back after its removal is that our current implementation always prioritizes the <code data-v-c2aeccce>removals</code> set. Let’s take the following scenario as an example:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>a<span class="token punctuation" data-v-c2aeccce>,</span> b<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>b<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>In this case, our Set will logically contain only element <code data-v-c2aeccce>a</code>, as element <code data-v-c2aeccce>b</code> is present in the <code data-v-c2aeccce>removals</code> set and thus ignored.</p>
<h2 id="attempt-0-removing-elements" data-v-c2aeccce><a href="#attempt-0-removing-elements" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Attempt 0: Removing elements</h2>
<p data-v-c2aeccce>If having <code data-v-c2aeccce>b</code> in the <code data-v-c2aeccce>removals</code> Set prevents us from restoring it, can’t we simply remove <code data-v-c2aeccce>b</code> from <code data-v-c2aeccce>removals</code> after re-adding it? For example:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>a<span class="token punctuation" data-v-c2aeccce>,</span> b<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>b<span class="token punctuation" data-v-c2aeccce>}</span>

<span class="token comment" data-v-c2aeccce>// Then user calls set.add("b")</span>

elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>a<span class="token punctuation" data-v-c2aeccce>,</span> b<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>Unfortunately, as we’ve seen in the previous chapter, removing elements from our sets becomes problematic once replicas and synchronization enter the picture. In those cases, deleting <code data-v-c2aeccce>b</code> from the <code data-v-c2aeccce>removals</code> set could cause it to randomly disappear again during synchronization, so we need a better solution.</p>
<h2 id="attempt-1-adding-timestamps" data-v-c2aeccce><a href="#attempt-1-adding-timestamps" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Attempt 1: Adding timestamps</h2>
<p data-v-c2aeccce>Let’s take a step back and focus on our expected outcome: our goal is to be able to add an element to the Set <em data-v-c2aeccce>after</em> removing it. If we had a way to determine whether our element was added before or after its removal, we could decide whether to ignore it or not. For example, if element <code data-v-c2aeccce>b</code> was added <em data-v-c2aeccce>after</em> removing element <code data-v-c2aeccce>b</code>, then element <code data-v-c2aeccce>b</code> should be included, but if element <code data-v-c2aeccce>b</code> was added <em data-v-c2aeccce>before</em> removing element <code data-v-c2aeccce>b</code>, then it should be ignored. In other words, we need some kind of <em data-v-c2aeccce>ordering</em> between our Set operations.</p>
<p data-v-c2aeccce>An initial approach to achieve ordering is to attach a timestamp to our additions and removals. We are going to do this by converting our <code data-v-c2aeccce>elements</code> and <code data-v-c2aeccce>removals</code> Sets into <em data-v-c2aeccce>Maps:</em></p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token comment" data-v-c2aeccce>// Before</span>
elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>a<span class="token punctuation" data-v-c2aeccce>,</span> b<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>b<span class="token punctuation" data-v-c2aeccce>}</span>

<span class="token comment" data-v-c2aeccce>// After</span>
elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-23"</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>In this case, the keys of our map represent the elements, while the values represent the time in which the elements were added or removed.</p>
<blockquote data-v-c2aeccce>
<p data-v-c2aeccce>Note: in the previous example, timestamps are represented as string dates to make them easier to read and understand by humans. This implementation would be quite inefficient in practice, so we are going to use Unix timestamps in the actual code.</p>
</blockquote>
<p data-v-c2aeccce>The time information will be provided by the <code data-v-c2aeccce>add</code> and <code data-v-c2aeccce>remove</code> methods:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>  <span class="token function" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>,</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>Date</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>getTime</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  <span class="token punctuation" data-v-c2aeccce>}</span>

  <span class="token function" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>,</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>Date</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>getTime</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  <span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>With the time information, we can finally refine our Set logic to support additions after removals:</p>
<blockquote data-v-c2aeccce>
<p data-v-c2aeccce>An element is present in our Set if:</p>
<ol data-v-c2aeccce>
<li data-v-c2aeccce>It’s present in the <code data-v-c2aeccce>elements</code> and not in the <code data-v-c2aeccce>removals</code></li>
<li data-v-c2aeccce>OR if the timestamp in the <code data-v-c2aeccce>elements</code> is greater or equal than the timestamp in the <code data-v-c2aeccce>removals</code></li>
</ol>
</blockquote>
<p data-v-c2aeccce>Thanks to the second condition, we are now able to add an element back after its removal. This works because whenever we <code data-v-c2aeccce>add</code> an element, we also update its timestamp, and if this timestamp is greater than the current <code data-v-c2aeccce>removals</code> timestamp, we consider the element to be present.</p>
<p data-v-c2aeccce>A possible implementation for the <code data-v-c2aeccce>has</code> method could be:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>  <span class="token function" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token keyword" data-v-c2aeccce>const</span> additionTime <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>get</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token keyword control-flow" data-v-c2aeccce>if</span> <span class="token punctuation" data-v-c2aeccce>(</span>additionTime <span class="token operator" data-v-c2aeccce>===</span> <span class="token keyword nil" data-v-c2aeccce>undefined</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
      <span class="token comment" data-v-c2aeccce>// Element was never added</span>
      <span class="token keyword control-flow" data-v-c2aeccce>return</span> <span class="token boolean" data-v-c2aeccce>false</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token keyword" data-v-c2aeccce>const</span> removalTime <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>get</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token keyword control-flow" data-v-c2aeccce>if</span> <span class="token punctuation" data-v-c2aeccce>(</span>removalTime<span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
      <span class="token comment" data-v-c2aeccce>// Was the element removed before or after its addition?</span>
      <span class="token keyword control-flow" data-v-c2aeccce>return</span> removalTime <span class="token operator" data-v-c2aeccce>&lt;=</span> additionTime<span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token comment" data-v-c2aeccce>// The element was never removed</span>
    <span class="token keyword control-flow" data-v-c2aeccce>return</span> <span class="token boolean" data-v-c2aeccce>true</span><span class="token punctuation" data-v-c2aeccce>;</span>
  <span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>Finally, to make our Set a proper CRDT, we’ll need to update the <code data-v-c2aeccce>merge</code> method as well:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>  <span class="token function" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>otherSet</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token keyword control-flow" data-v-c2aeccce>for</span> <span class="token punctuation" data-v-c2aeccce>(</span><span class="token keyword" data-v-c2aeccce>let</span> <span class="token punctuation" data-v-c2aeccce>[</span>element<span class="token punctuation" data-v-c2aeccce>,</span> additionTime<span class="token punctuation" data-v-c2aeccce>]</span> <span class="token keyword" data-v-c2aeccce>of</span> otherSet<span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
      <span class="token keyword" data-v-c2aeccce>const</span> existingAdditionTime <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>get</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
      <span class="token comment" data-v-c2aeccce>// Update the local addition time only if the remote addition time is greater</span>
      <span class="token keyword control-flow" data-v-c2aeccce>if</span> <span class="token punctuation" data-v-c2aeccce>(</span>
        existingAdditionTime <span class="token operator" data-v-c2aeccce>===</span> <span class="token keyword nil" data-v-c2aeccce>undefined</span> <span class="token operator" data-v-c2aeccce>||</span>
        existingAdditionTime <span class="token operator" data-v-c2aeccce>&lt;</span> additionTime
      <span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>,</span> additionTime<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
      <span class="token punctuation" data-v-c2aeccce>}</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token keyword control-flow" data-v-c2aeccce>for</span> <span class="token punctuation" data-v-c2aeccce>(</span><span class="token keyword" data-v-c2aeccce>let</span> <span class="token punctuation" data-v-c2aeccce>[</span>element<span class="token punctuation" data-v-c2aeccce>,</span> removalTime<span class="token punctuation" data-v-c2aeccce>]</span> <span class="token keyword" data-v-c2aeccce>of</span> otherSet<span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
      <span class="token keyword" data-v-c2aeccce>const</span> existingRemovalTime <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>get</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
      <span class="token comment" data-v-c2aeccce>// Update the local removal time only if the remote removal time is greater</span>
      <span class="token keyword control-flow" data-v-c2aeccce>if</span> <span class="token punctuation" data-v-c2aeccce>(</span>
        existingRemovalTime <span class="token operator" data-v-c2aeccce>===</span> <span class="token keyword nil" data-v-c2aeccce>undefined</span> <span class="token operator" data-v-c2aeccce>||</span>
        existingRemovalTime <span class="token operator" data-v-c2aeccce>&lt;</span> removalTime
      <span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>,</span> removalTime<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
      <span class="token punctuation" data-v-c2aeccce>}</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>
  <span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>We are now ready to test our Set again (the full code is available <a href="https://github.com/federico-terzi/crdt-experiments/blob/main/crdt-article-examples/part-2/set-with-timestamps.js" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce><strong data-v-c2aeccce>here</strong></a>):</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>  <span class="token keyword" data-v-c2aeccce>const</span> replicaA <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  <span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>

  <span class="token comment" data-v-c2aeccce>// Wait for some time between operation.</span>
  <span class="token comment" data-v-c2aeccce>// This way, the new Date.getTime() call can't return the same value</span>
  <span class="token keyword control-flow" data-v-c2aeccce>await</span> <span class="token function" data-v-c2aeccce>waitFor</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token number" data-v-c2aeccce>10</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>

  <span class="token keyword" data-v-c2aeccce>const</span> replicaB <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  <span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

  <span class="token keyword control-flow" data-v-c2aeccce>await</span> <span class="token function" data-v-c2aeccce>waitFor</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token number" data-v-c2aeccce>10</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>

  replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  <span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

  <span class="token keyword control-flow" data-v-c2aeccce>await</span> <span class="token function" data-v-c2aeccce>waitFor</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token number" data-v-c2aeccce>10</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>

  replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
  <span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>"a"</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true! Yay, 'a' is back!</span>
</code></pre></div>
<p data-v-c2aeccce>Yay, our Set can now handle additions after removals! Is this ready for production? Well, not exactly. Our current implementation suffers from a subtle, but very problematic edge case, which we’ll discuss in the next section.</p>
<h2 id="physical-time-and-distributed-systems" data-v-c2aeccce><a href="#physical-time-and-distributed-systems" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Physical time and distributed systems</h2>
<p data-v-c2aeccce>In the implementation we just discussed, timestamps play an important role: they allow us to tell which operation comes first. In other words, we are relying on timestamps to determine the <em data-v-c2aeccce>ordering of operations</em>, which in turn determines which elements are present in the set and which are not. Unfortunately, this approach can break down in subtle ways when dealing with distributed systems.</p>
<p data-v-c2aeccce>Most of our devices, including laptops and mobile phones, rely on a hardware device to keep track of time: the clock. These clocks are usually based on quartz oscillators and are not very precise, so every device has its own notion of time. For example, this is a picture of my car’s clock:</p>
<p data-v-c2aeccce><img alt="" src="/posts/2024-02-25-understanding-crdts-improving-our-set/image0.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>Every few weeks, I might need to adjust the time, as it might have drifted by one or two minutes. Some of you might be wondering: why isn’t this time drift happening on our phones and laptops? Well… it is! The reason we don’t notice is a protocol known as <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>NTP </a>(<em data-v-c2aeccce>Network Time Protocol)</em>, which allows internet-connected devices to periodically sync their time with NTP servers, down to a &lt;100ms precision. Unfortunately, my car is quite old and doesn’t have any kind of internet connectivity, so NTP is not an option there. Until I keep my car, I’ll need to keep the time up to date manually (though as you can see from the year, I’m not particularly good at it :D ).</p>
<p data-v-c2aeccce>As long as the NTP protocol works, our devices will have a reasonably precise clock, so why shouldn’t we rely on timestamps for the operation ordering?</p>
<p data-v-c2aeccce>In software systems, data integrity is usually one of the top concerns. For example, let’s take two hypothetical bugs:</p>
<ul data-v-c2aeccce>
<li data-v-c2aeccce>A bug causing application instances to crash</li>
<li data-v-c2aeccce>A bug silently corrupting data in our database</li>
</ul>
<p data-v-c2aeccce>Which one sounds scarier?</p>
<p data-v-c2aeccce>As a result, when designing a data structure like our CRDT Set, we should always think about the worst-case scenarios: what happens if the time in our local machine goes off? Let’s see an example, starting from this Set state:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-23"</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>Let’s say for some reason, our local time is completely off and we decide to remove element <code data-v-c2aeccce>b</code>. As we discussed before, this causes a new entry to be added to the <code data-v-c2aeccce>removals</code> map:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-23"</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2099-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span>  <span class="token comment" data-v-c2aeccce>// &lt;- year is set to 2099</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>From the user perspective, this works correctly: the element <code data-v-c2aeccce>b</code> is removed (because 2099 > 2024).</p>
<p data-v-c2aeccce>After a while, the CRDT Set is replicated to another replica, which might decide to add element <code data-v-c2aeccce>b</code> again. As a result, we update the timestamp of entry <code data-v-c2aeccce>b</code>  in the <code data-v-c2aeccce>elements</code> map:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2024-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token comment" data-v-c2aeccce>// &lt;- updated, but still less than 2099!</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token string" data-v-c2aeccce>"2099-02-24"</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>But this time, the <code data-v-c2aeccce>b</code> element does not come back… In fact, it will not come back for the next 75 years! By relying on physical timestamps to determine the order of operations, we might cause silent data loss or corruption in the case of out-of-time clocks. We can do better than that.</p>
<blockquote data-v-c2aeccce>
<p data-v-c2aeccce>Aside: How likely is this out-of-time scenario to happen?</p>
<p data-v-c2aeccce>Despite being a rare occurrence, these are some scenarios in which a device’s time could experience some edge-case behaviors:</p>
<ul data-v-c2aeccce>
<li data-v-c2aeccce>Firewalls could be misconfigured and temporarily block NTP synchronization, making the local clock slowly drift over time.</li>
<li data-v-c2aeccce>When the drift between the local clock and the NTP server clock is too large, the NTP protocol might decide to reset the local clock. From the perspective of local applications, the clock would have jumped forward or backward in time.</li>
<li data-v-c2aeccce>Users could even misconfigure their local time on purpose, for example, trying to elude “trial periods” of certain proprietary software.</li>
</ul>
<p data-v-c2aeccce>If you want to know more about this topic, I highly recommend reading the “Unreliable Clocks” chapter from <a href="https://www.oreilly.com/library/view/designing-data-intensive-applications/9781491903063/" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>Designing Data-Intensive Applications</a> by Martin Kleppmann, one of the best software engineering books ever written.</p>
</blockquote>
<p data-v-c2aeccce>So if physical timestamps are not a good option for this use case, what should we use? A better mechanism to determine the order of operations in distributed systems is <a href="https://en.wikipedia.org/wiki/Version_vector" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce><em data-v-c2aeccce>Version Vectors</em></a><em data-v-c2aeccce>,</em> which we are going to cover in the next section.</p>
<h2 id="attempt-2-version-vectors" data-v-c2aeccce><a href="#attempt-2-version-vectors" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Attempt 2: Version Vectors</h2>
<p data-v-c2aeccce>Version Vectors are a mechanism for tracking changes to data in a distributed system. Most importantly, they can do so without relying on physical time.</p>
<p data-v-c2aeccce>To introduce Version Vectors, let’s imagine a distributed scenario in which two replicas exist. We’ll call them Alice and Bob:</p>
<p data-v-c2aeccce><img alt="" src="/posts/2024-02-25-understanding-crdts-improving-our-set/image1.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>When using Version Vectors, each replica has to have a <strong data-v-c2aeccce>unique</strong> ID, which we’ll call <em data-v-c2aeccce>replica ID</em>. For simplicity, Alice will have <code data-v-c2aeccce>ID = alice</code> and Bob will have <code data-v-c2aeccce>ID = bob</code>.</p>
<p data-v-c2aeccce>Version Vectors can be thought of as <em data-v-c2aeccce>maps</em>, in which the keys are the replica IDs and the values are the number of changes to the data by the given replica. For example, when Alice adds a new element, the corresponding Version Vector will be:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>which can be read as “Alice has made one edit to the data so far”. If Alice performs another update, the Version Vector will become:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>And if this value is then modified by Bob, the Version Vector will become:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>which can be read as “Alice has made 2 edits to the data, while Bob made one edit”.</p>
<p data-v-c2aeccce>When executing an operation (either <code data-v-c2aeccce>add</code> or <code data-v-c2aeccce>remove</code> ), our CRDT Set will attach a Version Vector to the value, in the same way as we did with the timestamps:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>b</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>All good so far, but we still haven’t discussed how Version Vectors can help us. To answer that question, let’s take a step back: our goal is to determine whether a removal occurred <em data-v-c2aeccce>before or after</em> the corresponding addition, as that will determine whether the element is present in the set or not. In other words, we need a way to determine an <em data-v-c2aeccce>ordering</em> between the additions and removals of the same element. Version Vectors serve exactly that purpose, let’s see how:</p>
<p data-v-c2aeccce>Every time a replica executes an operation on a given element, it increments the corresponding counter in the Version Vector:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>

<span class="token comment" data-v-c2aeccce>// After an operation by Alice</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>Because we know that replica IDs are unique (more on this below), we can derive a partial ordering by comparing two version vectors. For example, given these two Version Vectors:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>we know that <code data-v-c2aeccce>{alice: 2}</code> <strong data-v-c2aeccce>must</strong> have come <em data-v-c2aeccce>after</em> <code data-v-c2aeccce>{alice: 1}</code> (because the replica IDs are unique and each operation causes an increment in the current replica counter). For example, let’s consider the following scenario:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>In this case, because <code data-v-c2aeccce>{alice: 2}</code> comes <em data-v-c2aeccce>after</em> <code data-v-c2aeccce>{alice: 1}</code>, we know that element <code data-v-c2aeccce>a</code> was removed. On the other hand, the following scenario displays a Set in which the element <code data-v-c2aeccce>a</code> is present:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>3</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token comment" data-v-c2aeccce>// &lt;- 3 is greater than 2, so 'a' is present</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>When multiple replicas modify the same data, each replica increments its own counter. For example:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>

<span class="token comment" data-v-c2aeccce>// After Bob modifies the data</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>By comparing these two version vectors, we know that <code data-v-c2aeccce>{alice: 1, bob: 1}</code> comes <em data-v-c2aeccce>after</em> <code data-v-c2aeccce>{alice: 1}</code>, because the former is a superset of the latter. In other words, a version vector A is greater than a version vector B if all counters of A are greater or equal to the corresponding counters on B.</p>
<p data-v-c2aeccce>So in the following scenario, we know that <code data-v-c2aeccce>a</code> is not present in the Set:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span> <span class="token comment" data-v-c2aeccce>// &lt;- This VV is greater than {alice: 1}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>The trickiest scenario happens when two replicas modify the same data concurrently:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>

<span class="token comment" data-v-c2aeccce>// Alice modifies the value</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token comment" data-v-c2aeccce>// At the same time, Bob modifies the value</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>Does <code data-v-c2aeccce>{alice: 2}</code>  come before or after <code data-v-c2aeccce>{alice: 1, bob: 1}</code>? Neither of the two! The two version vectors are <em data-v-c2aeccce>concurrent</em>. In other words, we can’t tell which update came first by just looking at their version vectors. What should we do in this case? Let’s discuss an example to illustrate a possible approach.</p>
<p data-v-c2aeccce>Let’s assume both Alice and Bob start from the following state:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>From the rules we discussed before, we know that this Set contains element <code data-v-c2aeccce>a</code> .</p>
<p data-v-c2aeccce>Then, each replica updates its set concurrently. In particular, Alice removes and then adds <code data-v-c2aeccce>a</code> again:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>3</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>While Bob only removes <code data-v-c2aeccce>a</code>, without adding it back:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>When the two replicas synchronize, a conflict occurs: should <code data-v-c2aeccce>a</code> be present or not? Should the actions of Alice take precedence over the ones from Bob, or vice versa? It depends on the application, as different use cases require different approaches.</p>
<p data-v-c2aeccce>A safe approach we could use is <em data-v-c2aeccce>prioritizing additions over removals when a conflict occurs</em>, a policy known as <em data-v-c2aeccce>Add Wins</em>. According to this logic, if some replica deletes an element while another replica adds it, then the addition should “win”. This policy is the safest as it minimizes the risk of unwanted data loss. For example, it would be easy for Bob to remove element <code data-v-c2aeccce>a</code> again if he’s really convinced about his choice, with minimal UX impact. But if we didn’t adopt the Add-Win policy, Alice might have element <code data-v-c2aeccce>a</code> silently disappear after the synchronization, which could lead to a bad UX.</p>
<blockquote data-v-c2aeccce>
<p data-v-c2aeccce>Note: Different approaches to conflict resolution are possible, the most suitable of which depends on the specific use case. For example, some applications might require to “merge” elements when a conflict occurs, rather than having one override the other. Others might prefer the removal operation to take precedence.</p>
</blockquote>
<p data-v-c2aeccce>If we opt for the Add-Wins policy in our CRDT Set, Alice’s addition will win over Bob’s removal. The only thing left to figure out is what the Version Vector will be.</p>
<p data-v-c2aeccce>When a conflict occurs, we are going to <em data-v-c2aeccce>merge</em> the two Version Vectors. A merge consists of creating a Version Vector whose counters are the maximum value across all conflicting vectors’ counters. For example, merging <code data-v-c2aeccce>{alice: 2}</code> with <code data-v-c2aeccce>{alice: 1, bob: 1}</code> will result in <code data-v-c2aeccce>{alice: 2, bob: 1}</code>. By applying this logic to our previous example, we’ll end up with the following state:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>3</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token comment" data-v-c2aeccce>// &lt;- merged vector</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>
  <span class="token literal-property property" data-v-c2aeccce>a</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span> <span class="token comment" data-v-c2aeccce>// The value of the removals version vector doesn't really matter, as long as it's smaller than the addition version vector</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>The resulting set will contain element <code data-v-c2aeccce>a</code> , because the resulting vector (<code data-v-c2aeccce>{alice: 3, bob: 1}</code> ) is greater than the vector in <code data-v-c2aeccce>removals</code>.</p>
<p data-v-c2aeccce>An important side-effect of the merge, which might not be obvious at first, is that the resulting version vector now “encodes” the fact that it came after <strong data-v-c2aeccce>both</strong> concurrent updates. In other words, we can tell for sure that this addition comes after both Alice’s addition and Bob’s removal. This allows us to accurately track the way our data evolves when multiple replicas update it.</p>
<p data-v-c2aeccce>We now have all the necessary ingredients to implement our Version Vector CRDT Set in JS. Because the implementation is quite long, I’ve decided to not include it in the article, but you can find it on the GitHub repo <a href="https://github.com/federico-terzi/crdt-experiments/blob/main/crdt-article-examples/part-2/set-with-version-vector.js" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>here</a>.</p>
<p data-v-c2aeccce>All right! We now have implemented a CRDT Set that supports additions, removals, and concurrent updates without relying on physical clocks, making it more robust for use in distributed systems.</p>
<h2 id="remarks-on-replica-ids" data-v-c2aeccce><a href="#remarks-on-replica-ids" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Remarks on Replica IDs</h2>
<p data-v-c2aeccce>An important discussion we should have is related to Replica IDs. Version Vectors (as well as other approaches we’ll discuss in the upcoming chapters) rely on the fact that every replica has a <strong data-v-c2aeccce>unique</strong> ID. Without the uniqueness guarantee, we couldn’t infer an ordering between two Version Vectors. For example, if two replicas had <code data-v-c2aeccce>Alice</code> as replica ID, we couldn’t tell for sure if the version vector <code data-v-c2aeccce>{alice: 2}</code> comes after <code data-v-c2aeccce>{alice: 1}</code>. We can infer an ordering only when we can safely assume that a replica counter will only be incremented by a single replica (based on the ReplicaID).</p>
<p data-v-c2aeccce>You will find this ID uniqueness requirement in most CRDT implementations. In fact, many CRDTs explicitly mention that it’s up to you to guarantee unique replica IDs, otherwise you might face data corruption (eg. <a href="https://docs.rs/yrs/latest/yrs/#quick-start" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>here</a>).</p>
<p data-v-c2aeccce>This requirement is made more complex by the fact that CRDTs are typically used in distributed P2P scenarios. In those cases, we can’t rely on a central authority to assign IDs that are guaranteed to be globally unique. The most popular solution in those cases is to generate a random replica ID large enough to be statistically unlikely to conflict with another replica ID. The downside of large replica IDs is that they can take up quite a bit of storage within our CRDT, depending on the implementation. So in these cases, we need to balance our accepted risk of data corruption with our efficiency requirements or introduce a global “coordination” entity to assign unique IDs.</p>
<h2 id="remarks-on-version-vectors-storage" data-v-c2aeccce><a href="#remarks-on-version-vectors-storage" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Remarks on Version Vectors storage</h2>
<p data-v-c2aeccce>Version Vectors are a powerful tool in our distributed systems toolbox. Their main downside is that they can take quite a bit of storage in our data structure, and in certain scenarios, a <em data-v-c2aeccce>lot</em> of storage.</p>
<p data-v-c2aeccce>The ideal scenario for Version Vectors is when any given data entry is only ever modified by a single replica:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>2</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>3</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>As you can see, because our data is only modified by Alice, our Version Vector’s size doesn’t grow.</p>
<p data-v-c2aeccce>If at some point another replica decides to modify the data, our Version Vector’s size grows by one:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>3</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>Therefore, the worst-case scenario happens when a data entry is modified by a different replica every time:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="language-javascript line-numbers" data-v-c2aeccce><code data-v-c2aeccce><span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>carl</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token constant" data-v-c2aeccce>VV</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token literal-property property" data-v-c2aeccce>alice</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>bob</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>carl</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>,</span> <span class="token literal-property property" data-v-c2aeccce>david</span><span class="token operator" data-v-c2aeccce>:</span> <span class="token number" data-v-c2aeccce>1</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>That adds up quickly!</p>
<p data-v-c2aeccce>The problem is that we can fall into this worst-case scenario quite easily if we are not careful. For example, given that replica IDs have to be unique, we could decide to solve the problem by generating a random ID every time our CRDT is initialized. At this point, every time we modify the same entry, the Version Vector size will grow by one. Given that our CRDT is likely to be initialized at least once every time the user starts our application, modifying the same entries will cause the Version Vector size to grow fast!</p>
<p data-v-c2aeccce>For some use cases, this might not be a significant problem, for example in scenarios in which the creation of new objects is more common than edits or when Replica IDs can be reused among different sessions. There is also a more efficient version of Version Vectors called <em data-v-c2aeccce>Dotted Version Vectors</em>, which in some cases can bring significant space savings. We’ll hopefully cover it in a future chapter of the series, so stay tuned :)</p>
<h1 id="conclusions" data-v-c2aeccce><a href="#conclusions" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Conclusions</h1>
<p data-v-c2aeccce>That was quite a ride! We finally have a working CRDT Set implementation, but there is still a lot to discuss:</p>
<ul data-v-c2aeccce>
<li data-v-c2aeccce>Our CRDT Set only keeps growing over time, even after we remove elements. Can we implement deletes more efficiently?</li>
<li data-v-c2aeccce>When we synchronize the replicas of our CRDT, we currently need to send the entire state to each other, which could become prohibitive expensive after a certain size. Can we implement a more efficient synchronization in which only the “new” data is sent over the wire?</li>
<li data-v-c2aeccce>What about other data structures like Lists and Maps?</li>
</ul>
<p data-v-c2aeccce>These will be the topics of the next chapters, so stay tuned!</p>
<p data-v-c2aeccce>PS: All the code is available in this repository: <a href="https://github.com/federico-terzi/crdt-experiments" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>https://github.com/federico-terzi/crdt-experiments</a></p></div></div> <div class="post-footer-container post-footer" data-v-63505c64 data-v-c2aeccce><img src="/_nuxt/img/profile-picture-small.40e71b2.png" alt="Federico Terzi Picture" class="post-footer-image" data-v-63505c64> <div class="post-footer-content" data-v-63505c64><p data-v-63505c64>Hi 👋, I’m <span class="red" data-v-63505c64>Federico</span>, thanks for reading!</p> <p data-v-63505c64>
      If you liked this article, make sure to follow me on
      <a href="https://twitter.com/terzi_federico" class="blue" data-v-63505c64>Twitter</a> to
      stay updated with the latest ones :)
    </p> <p data-v-63505c64>
      If you are into technical topics, you might also enjoy my
      <a href="https://www.youtube.com/c/FedericoTerzi" class="red" data-v-63505c64>YouTube</a>
      channel.
    </p></div></div></div></article></div> <div class="footer-container" data-v-d5d2bd86><p data-v-d5d2bd86><span class="bold" data-v-d5d2bd86>Designed</span> and
    <span class="bold" data-v-d5d2bd86>coded</span> with<span class="red" data-v-d5d2bd86> ♥</span> by me.
    Copyright © Federico Terzi 2019-2024 - P.IVA 03864201201
  </p></div> <div class="social-bar-container"><a href="https://twitter.com/terzi_federico"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23 3.00005C22.0424 3.67552 20.9821 4.19216 19.86 4.53005C19.2577 3.83756 18.4573 3.34674 17.567 3.12397C16.6767 2.90121 15.7395 2.95724 14.8821 3.2845C14.0247 3.61176 13.2884 4.19445 12.773 4.95376C12.2575 5.71308 11.9877 6.61238 12 7.53005V8.53005C10.2426 8.57561 8.50127 8.18586 6.93101 7.39549C5.36074 6.60513 4.01032 5.43868 3 4.00005C3 4.00005 -1 13 8 17C5.94053 18.398 3.48716 19.099 1 19C10 24 21 19 21 7.50005C20.9991 7.2215 20.9723 6.94364 20.92 6.67005C21.9406 5.66354 22.6608 4.39276 23 3.00005V3.00005Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></a> <div class="social-bar-divider"></div> <a href="https://github.com/federico-terzi/"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_31_53)"><path d="M16 21.9999V18.1299C16.0375 17.6531 15.9731 17.1737 15.811 16.7237C15.6489 16.2737 15.3929 15.8634 15.06 15.5199C18.2 15.1699 21.5 13.9799 21.5 8.51994C21.4997 7.12376 20.9627 5.78114 20 4.76994C20.4559 3.54844 20.4236 2.19829 19.91 0.999938C19.91 0.999938 18.73 0.649938 16 2.47994C13.708 1.85876 11.292 1.85876 9 2.47994C6.27 0.649938 5.09 0.999938 5.09 0.999938C4.57638 2.19829 4.54414 3.54844 5 4.76994C4.03013 5.78864 3.49252 7.1434 3.5 8.54994C3.5 13.9699 6.8 15.1599 9.94 15.5499C9.611 15.8899 9.35726 16.2953 9.19531 16.7399C9.03335 17.1844 8.96681 17.658 9 18.1299V21.9999M9 18.9999C4 20.4999 4 16.4999 2 15.9999L9 18.9999Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0_31_53"><rect width="24" height="24" fill="white"></rect></clipPath></defs></svg></a> <div class="social-bar-divider"></div> <a href="https://www.linkedin.com/in/federico-terzi/"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 8C17.5913 8 19.1174 8.63214 20.2426 9.75736C21.3679 10.8826 22 12.4087 22 14V21H18V14C18 13.4696 17.7893 12.9609 17.4142 12.5858C17.0391 12.2107 16.5304 12 16 12C15.4696 12 14.9609 12.2107 14.5858 12.5858C14.2107 12.9609 14 13.4696 14 14V21H10V14C10 12.4087 10.6321 10.8826 11.7574 9.75736C12.8826 8.63214 14.4087 8 16 8V8Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6 9H2V21H6V9Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 6C5.10457 6 6 5.10457 6 4C6 2.89543 5.10457 2 4 2C2.89543 2 2 2.89543 2 4C2 5.10457 2.89543 6 4 6Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></a> <div class="social-bar-divider"></div> <a href="https://www.youtube.com/c/FedericoTerzi"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.54 6.42C22.4212 5.94541 22.1793 5.51057 21.8387 5.15941C21.498 4.80824 21.0708 4.55318 20.6 4.42C18.88 4 12 4 12 4C12 4 5.12001 4 3.40001 4.46C2.92925 4.59318 2.50198 4.84824 2.16135 5.19941C1.82072 5.55057 1.5788 5.98541 1.46001 6.46C1.14522 8.20556 0.991243 9.97631 1.00001 11.75C0.988786 13.537 1.14277 15.3213 1.46001 17.08C1.59097 17.5398 1.83831 17.9581 2.17815 18.2945C2.51799 18.6308 2.93883 18.8738 3.40001 19C5.12001 19.46 12 19.46 12 19.46C12 19.46 18.88 19.46 20.6 19C21.0708 18.8668 21.498 18.6118 21.8387 18.2606C22.1793 17.9094 22.4212 17.4746 22.54 17C22.8524 15.2676 23.0063 13.5103 23 11.75C23.0112 9.96295 22.8572 8.1787 22.54 6.42V6.42Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M9.75 15.02L15.5 11.75L9.75 8.47998V15.02Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></a></div></div></div></div><script defer src="/_nuxt/static/1725896671/blog/understanding-crdts-improving-our-set-chapter-2/state.js"></script><script src="/_nuxt/fd722ce.js" defer></script><script src="/_nuxt/f5ea8a1.js" defer></script><script src="/_nuxt/17ba505.js" defer></script><script src="/_nuxt/4293a24.js" defer></script><script src="/_nuxt/cd10c32.js" defer></script>
  </body>
</html>
