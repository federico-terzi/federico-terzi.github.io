<!doctype html>
<!-- 
  Hi there! Welcome to my website :)
  It seems you are interested in the source code, did you
  know that the website is open-source? See:
  https://github.com/federico-terzi/federico-terzi.github.io
-->
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Understanding CRDTs: A Gentle Introduction (Chapter 1) - Federico Terzi - A Software Engineering Journey</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="title" name="title" content="Federico Terzi - A Software Engineering Journey"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><meta data-n-head="ssr" data-hid="description" name="description" content="In the past two months, I’ve been diving deeper into the realm of distributed systems. The catalyst that started my research was discovering the world of local-first applications, a class of software that allows users to access and modify their data locally, while seamlessly synchronizing across devices, even in the face of connection failures."><meta data-n-head="ssr" data-hid="og:title" property="og:title" content="Understanding CRDTs: A Gentle Introduction (Chapter 1)"><meta data-n-head="ssr" data-hid="og:description" property="og:description" content="In the past two months, I’ve been diving deeper into the realm of distributed systems. The catalyst that started my research was discovering the world of local-first applications, a class of software that allows users to access and modify their data locally, while seamlessly synchronizing across devices, even in the face of connection failures."><meta data-n-head="ssr" data-hid="og:image" property="og:image" content="https://federicoterzi.com/social/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1.png"><meta data-n-head="ssr" name="twitter:card" content="summary"><meta data-n-head="ssr" name="twitter:site" content="@terzi_federico"><meta data-n-head="ssr" name="twitter:title" content="Understanding CRDTs: A Gentle Introduction (Chapter 1)"><meta data-n-head="ssr" name="twitter:description" content="In the past two months, I’ve been diving deeper into the realm of distributed systems. The catalyst that started my research was discovering the world of local-first applications, a class of software that allows users to access and modify their data locally, while seamlessly synchronizing across devices, even in the face of connection failures."><meta data-n-head="ssr" name="twitter:image" content="https://federicoterzi.com/social/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1.png"><link data-n-head="ssr" rel="stylesheet" href="/colors.css"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"><link data-n-head="ssr" rel="manifest" href="/site.webmanifest"><link data-n-head="ssr" rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180"><link data-n-head="ssr" rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="preload" href="/_nuxt/4aae9c2.js" as="script"><link rel="preload" href="/_nuxt/17ba505.js" as="script"><link rel="preload" href="/_nuxt/4293a24.js" as="script"><link rel="preload" href="/_nuxt/cd10c32.js" as="script"><link rel="preload" href="/_nuxt/f5ea8a1.js" as="script"><style data-vue-ssr-id="c3ae2b30:0 d75bdb94:0 fa7ff0ca:0 56b15182:0 7ab12987:0 68efd426:0 4c3275e1:0 1dd63c10:0 0356ed00:0 fcd77316:0 fcd9470c:0 71a90360:0">@font-face{font-family:Inter;font-style:normal;font-weight:400;font-display:swap;src:url(/_nuxt/fonts/inter-v7-latin-regular.33e43c3.eot);src:local(""),url(/_nuxt/fonts/inter-v7-latin-regular.33e43c3.eot?#iefix) format("embedded-opentype"),url(/_nuxt/fonts/inter-v7-latin-regular.5e6a773.woff2) format("woff2"),url(/_nuxt/fonts/inter-v7-latin-regular.cefb4aa.woff) format("woff"),url(/_nuxt/fonts/inter-v7-latin-regular.0e67589.ttf) format("truetype"),url(/_nuxt/b8db5cf5416facf0c5ec4489d0ee9bbe.svg#Inter) format("svg")}@font-face{font-family:Inter;font-style:normal;font-weight:700;font-display:swap;src:url(/_nuxt/fonts/inter-v7-latin-700.129e115.eot);src:local(""),url(/_nuxt/fonts/inter-v7-latin-700.129e115.eot?#iefix) format("embedded-opentype"),url(/_nuxt/fonts/inter-v7-latin-700.c2ceaa0.woff2) format("woff2"),url(/_nuxt/fonts/inter-v7-latin-700.7f5a89b.woff) format("woff"),url(/_nuxt/fonts/inter-v7-latin-700.6bb53f6.ttf) format("truetype"),url(/_nuxt/0a85e1f2fd11f8afbfa155c7c5ec0a12.svg#Inter) format("svg")}@font-face{font-family:"PT Serif";font-style:normal;font-weight:400;font-display:swap;src:url(/_nuxt/fonts/pt-serif-v16-latin-regular.ef9b698.eot);src:local(""),url(/_nuxt/fonts/pt-serif-v16-latin-regular.ef9b698.eot?#iefix) format("embedded-opentype"),url(/_nuxt/fonts/pt-serif-v16-latin-regular.511cda7.woff2) format("woff2"),url(/_nuxt/fonts/pt-serif-v16-latin-regular.b4f2a8d.woff) format("woff"),url(/_nuxt/fonts/pt-serif-v16-latin-regular.1602721.ttf) format("truetype"),url(/_nuxt/2b24347634a541da72419674a1818855.svg#PTSerif) format("svg")}html{--content-primary:#1a1a1a;--content-primary-inverted:#fff;--accent-primary:#c84c32;--accent-secondary:#2e4364;--accent-tertiary:#ecdbba;--accent-menu:#2e4364;--background-primary:#fff;--background-elevated:#f1f1f1;--background-semitransparent:hsla(0,0%,100%,0.7);--details:rgba(26,26,26,0.1)}html[data-theme=dark]{--content-primary:#fff;--content-primary-inverted:#1a1a1a;--accent-primary:#ef6b50;--accent-secondary:#8bb8ff;--accent-tertiary:#ecdbba;--accent-menu:#fff;--background-primary:#000;--background-elevated:#343434;--background-semitransparent:rgba(0,0,0,0.7);--details:hsla(0,0%,100%,0.1)}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}body,html{font-family:Inter,sans-serif;color:var(--content-primary);background-color:transparent;margin:0;padding:0}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.main-layout-container{max-width:1512px;margin:auto}.main-layout-content{padding-top:95px;min-height:100vh}@media (max-width:992px){.main-layout-content{padding-top:50px;max-width:100vw;overflow-x:hidden}}.container[data-v-71b3c000]{position:fixed;top:0;left:0;right:0;bottom:0;width:100%;height:100%;overflow:hidden;z-index:-10;background-color:var(--background-primary);transition:all .5s ease}.blurred[data-v-71b3c000]{filter:blur(50px);height:450px;width:450px}.animate[data-v-71b3c000]{-webkit-animation:rotate-center-data-v-71b3c000 120s linear infinite both;animation:rotate-center-data-v-71b3c000 120s linear infinite both}.red[data-v-71b3c000]{top:25vh;left:-10vw;background-color:var(--accent-primary)}.blue[data-v-71b3c000],.red[data-v-71b3c000]{position:absolute;opacity:.15}.blue[data-v-71b3c000]{top:0;right:-10vw;background-color:var(--accent-secondary)}.yellow[data-v-71b3c000]{position:absolute;top:75vh;left:40vw;background-color:var(--accent-tertiary);opacity:.4}html[data-theme=dark] .yellow[data-v-71b3c000]{opacity:.2}@media (max-width:992px){.blurred[data-v-71b3c000]{height:300px;width:300px}}@-webkit-keyframes rotate-center-data-v-71b3c000{0%{transform:rotate(0) translateX(0) translateY(0)}50%{transform:rotate(180deg) translateX(300px) translateY(300px)}to{transform:rotate(1turn) translateX(0) translateY(0)}}@keyframes rotate-center-data-v-71b3c000{0%{transform:rotate(0) translateX(0) translateY(0)}50%{transform:rotate(180deg) translateX(300px) translateY(300px)}to{transform:rotate(1turn) translateX(0) translateY(0)}}.header[data-v-47a7b6cf]{position:fixed;top:0;right:0;left:0;z-index:20;background-color:transparent;box-shadow:none;transition:all .2s ease-in-out}html:not([data-scroll="0"]) .header[data-v-47a7b6cf]{background-color:var(--background-primary);box-shadow:0 4px 43px rgba(0,0,0,.1)}.content[data-v-47a7b6cf]{display:flex;align-items:center;justify-content:space-between;padding:25px;max-width:1512px;margin:auto}.logo-link[data-v-47a7b6cf]{text-decoration:none}.details[data-v-47a7b6cf]{display:flex}.logo[data-v-47a7b6cf]{margin-right:16px}.details-text[data-v-47a7b6cf]{display:flex;flex-direction:column;justify-content:center}.name[data-v-47a7b6cf]{font-size:24px;line-height:28px;color:var(--accent-primary)}.name[data-v-47a7b6cf],.tagline[data-v-47a7b6cf]{font-weight:700;text-shadow:0 4px 4px rgba(0,0,0,.05)}.tagline[data-v-47a7b6cf]{font-size:14px;line-height:17px;opacity:.8;color:var(--content-primary)}html[data-theme=dark] .tagline[data-v-47a7b6cf]{opacity:.9}.menu-link[data-v-47a7b6cf]{position:relative;font-style:normal;font-weight:700;font-size:18px;line-height:22px;color:var(--accent-menu);margin-left:48px;text-decoration:none;transition:all .3s ease}.menu-link[data-v-47a7b6cf]:hover{color:var(--accent-primary)}.menu-link[data-v-47a7b6cf]:after{content:"";position:absolute;display:block;width:100%;height:2px;bottom:-3px;left:0;background-color:var(--accent-secondary);transform:scaleX(0);opacity:0;transition:all .3s ease}.menu-link[data-v-47a7b6cf]:hover:after{transform:scaleX(1);opacity:1;background-color:var(--accent-primary)}.open-mobile-menu[data-v-47a7b6cf]{display:none}.mobile-menu[data-v-47a7b6cf]{position:fixed;top:0;left:0;right:0;bottom:0;background-color:var(--background-semitransparent);z-index:1000;box-shadow:0 3px 18px rgba(0,0,0,.1);display:flex;flex-direction:column;justify-content:center;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);perspective:1000px}.menu-divider[data-v-47a7b6cf]{opacity:.05;border-bottom:2px solid #2e4364;margin-right:32px;margin-left:32px}.fade-enter-active[data-v-47a7b6cf],.fade-leave-active[data-v-47a7b6cf]{transition:opacity .5s}.fade-enter[data-v-47a7b6cf],.fade-leave-to[data-v-47a7b6cf]{opacity:0;-webkit-backdrop-filter:blur(0);backdrop-filter:blur(0)}@media (max-width:992px){.name[data-v-47a7b6cf]{font-size:14px;line-height:17px}.tagline[data-v-47a7b6cf]{display:none}.details-text[data-v-47a7b6cf]{opacity:0;transition:opacity .2s ease-in-out}html:not([data-scroll="0"]) .details-text[data-v-47a7b6cf]{opacity:1}.content[data-v-47a7b6cf]{padding:14px}.extended-menu[data-v-47a7b6cf]{display:none}.open-mobile-menu[data-v-47a7b6cf]{display:block;margin-right:4px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.25))}.menu-link[data-v-47a7b6cf]{text-align:center;margin-left:0;margin-top:18px;margin-bottom:18px;-webkit-animation:slide-in-bck-center-data-v-47a7b6cf .7s cubic-bezier(.25,.46,.45,.94) both;animation:slide-in-bck-center-data-v-47a7b6cf .7s cubic-bezier(.25,.46,.45,.94) both}.mobile-menu-links[data-v-47a7b6cf]{display:flex;flex-direction:column;justify-content:center;flex:1}.mobile-menu-label[data-v-47a7b6cf]{text-align:center;font-size:12px;margin-bottom:100px}}@-webkit-keyframes slide-in-bck-center-data-v-47a7b6cf{0%{transform:translateZ(600px);opacity:0}to{transform:translateZ(0);opacity:1}}@keyframes slide-in-bck-center-data-v-47a7b6cf{0%{transform:translateZ(600px);opacity:0}to{transform:translateZ(0);opacity:1}}.container[data-v-66baf38d]{position:relative;width:46px;height:46px}.f[data-v-66baf38d],.t[data-v-66baf38d]{position:absolute}.t[data-v-66baf38d]{left:-3px;top:-1px}@media (max-width:992px){.container[data-v-66baf38d],.f[data-v-66baf38d],.t[data-v-66baf38d]{height:32px;width:32px}.t[data-v-66baf38d]{left:-1px;top:0}}.post-title[data-v-c2aeccce]{font-style:normal;font-weight:700;font-size:36px;line-height:44px;color:var(--content-primary);margin-top:0;margin-bottom:6px}.post-details[data-v-c2aeccce]{font-size:14px;line-height:17px;color:var(--content-secondary);margin-bottom:34px}.post-footer[data-v-c2aeccce]{margin-top:28px}.short-page-container{max-width:700px;margin-right:auto;margin-left:auto;margin-top:30px;padding:28px}.short-page-title{margin-bottom:50px;margin-left:-8px}@media (max-width:992px){.short-page-container{margin-top:10px}}.post-footer-container[data-v-63505c64]{font-size:18px;line-height:22px;border-top:1px solid var(--details);padding-top:28px;display:flex}.post-footer-image[data-v-63505c64]{height:138px;width:138px}.post-footer-content[data-v-63505c64]{margin-left:28px}.post-footer-content p[data-v-63505c64]:first-child{margin-top:0}.red[data-v-63505c64]{color:var(--accent-primary)}.blue[data-v-63505c64],.red[data-v-63505c64]{font-weight:700}.blue[data-v-63505c64]{color:var(--accent-secondary)}a[data-v-63505c64]{text-underline-offset:2px;text-decoration-thickness:2px}@media (max-width:992px){.post-footer-container[data-v-63505c64]{align-items:center;flex-direction:column}.post-footer-content[data-v-63505c64]{margin-left:0;margin-top:28px}}.footer-container[data-v-d5d2bd86]{font-size:14px;line-height:17px;text-align:center;color:var(--accent-menu);margin-top:40px;padding-right:16px;padding-left:16px}.bold[data-v-d5d2bd86]{font-weight:700}.red[data-v-d5d2bd86]{color:var(--accent-primary)}.social-bar-container{position:fixed;left:24px;bottom:24px;background:var(--background-elevated);border:1px solid var(--details);box-sizing:border-box;box-shadow:0 3px 8px 2px rgba(0,0,0,.1);border-radius:4px;display:flex;justify-content:space-evenly;width:360px;padding-top:10px;padding-bottom:10px;transition:all .3s ease}html[data-scrolled-to-bottom=true] .social-bar-container{opacity:0;transform:translateY(100px)}.social-bar-container a{display:flex;align-items:center;filter:drop-shadow(0 4px 6px rgba(0,0,0,.25));transition:all .3s ease}.social-bar-container a:hover{transform:scale(1.2) translateY(-3px)}.social-bar-container a path{stroke:var(--accent-primary)}.social-bar-divider{border-left:1px solid var(--details)}@media (max-width:992px){.social-bar-container{left:0;right:0;bottom:0;width:100%;border-radius:0}}</style><link rel="preload" href="/_nuxt/static/1712253390/blog/understanding-crdts-a-gentle-introduction-chapter-1/state.js" as="script"><link rel="preload" href="/_nuxt/static/1712253390/blog/understanding-crdts-a-gentle-introduction-chapter-1/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1712253390/manifest.js" as="script">
    <script>const debounce=t=>{let c;return(...e)=>{c&&cancelAnimationFrame(c),c=requestAnimationFrame(()=>{t(...e)})}},handleScroll=()=>{document.documentElement.dataset.scroll=window.scrollY,document.documentElement.dataset.scrolledToBottom=window.innerHeight+window.scrollY>=document.body?.offsetHeight?"true":"false"};function switchTheme(e){"dark"===e?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light")}document.addEventListener("scroll",debounce(handleScroll),{passive:!0}),handleScroll();const prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)");prefersDarkScheme.matches&&switchTheme("dark"),window.matchMedia("(prefers-color-scheme: dark)").addListener(e=>e.matches?switchTheme("dark"):switchTheme("light"))</script>
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="main-layout-container"><div class="container" data-v-71b3c000><div class="blurred red animate" data-v-71b3c000></div> <div class="blurred yellow animate" data-v-71b3c000></div> <div class="blurred blue animate" data-v-71b3c000></div></div> <div id="header" class="header" data-v-47a7b6cf><div class="content" data-v-47a7b6cf><a href="/" class="logo-link nuxt-link-active" data-v-47a7b6cf><div class="details" data-v-47a7b6cf><div class="container logo" data-v-66baf38d data-v-47a7b6cf><svg width="51" height="47" viewBox="0 0 51 47" fill="none" xmlns="http://www.w3.org/2000/svg" class="f" data-v-66baf38d data-v-66baf38d><g filter="url(#filter0_d_15_34)" data-v-66baf38d data-v-66baf38d><path d="M2.09039 44.1666V2H48L2.09039 44.1666Z" fill="#C84C32" data-v-66baf38d data-v-66baf38d></path></g><defs data-v-66baf38d data-v-66baf38d><filter id="filter0_d_15_34" x="0.0543151" y="0.506876" width="49.9818" height="46.2388" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB" data-v-66baf38d data-v-66baf38d><feFlood flood-opacity="0" result="BackgroundImageFix" data-v-66baf38d data-v-66baf38d></feFlood><feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" data-v-66baf38d data-v-66baf38d></feColorMatrix><feOffset dy="0.542954" data-v-66baf38d data-v-66baf38d></feOffset><feGaussianBlur stdDeviation="1.01804" data-v-66baf38d data-v-66baf38d></feGaussianBlur><feComposite in2="hardAlpha" operator="out" data-v-66baf38d data-v-66baf38d></feComposite><feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" data-v-66baf38d data-v-66baf38d></feColorMatrix><feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_15_34" data-v-66baf38d data-v-66baf38d></feBlend><feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_15_34" result="shape" data-v-66baf38d data-v-66baf38d></feBlend></filter></defs></svg> <svg width="53" height="49" viewBox="0 0 53 49" fill="none" xmlns="http://www.w3.org/2000/svg" class="t" data-v-66baf38d data-v-66baf38d><g filter="url(#filter0_d_15_35)" data-v-66baf38d data-v-66baf38d><path d="M28.0452 45.0836L5 3H51L28.0452 45.0836Z" fill="url(#paint0_linear_15_35)" data-v-66baf38d data-v-66baf38d></path></g><defs data-v-66baf38d data-v-66baf38d><filter id="filter0_d_15_35" x="0.656367" y="0.556706" width="51.9725" height="48.0561" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB" data-v-66baf38d data-v-66baf38d><feFlood flood-opacity="0" result="BackgroundImageFix" data-v-66baf38d data-v-66baf38d></feFlood><feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" data-v-66baf38d data-v-66baf38d></feColorMatrix><feOffset dx="-1.35739" dy="0.542954" data-v-66baf38d data-v-66baf38d></feOffset><feGaussianBlur stdDeviation="1.49312" data-v-66baf38d data-v-66baf38d></feGaussianBlur><feComposite in2="hardAlpha" operator="out" data-v-66baf38d data-v-66baf38d></feComposite><feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0" data-v-66baf38d data-v-66baf38d></feColorMatrix><feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_15_35" data-v-66baf38d data-v-66baf38d></feBlend><feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_15_35" result="shape" data-v-66baf38d data-v-66baf38d></feBlend></filter><linearGradient id="paint0_linear_15_35" x1="28" y1="3" x2="28" y2="45.0836" gradientUnits="userSpaceOnUse" data-v-66baf38d data-v-66baf38d><stop stop-color="#ECDBBA" stop-opacity="0.49" data-v-66baf38d data-v-66baf38d></stop><stop offset="1" stop-color="#ECDBBA" data-v-66baf38d data-v-66baf38d></stop></linearGradient></defs></svg></div> <div class="details-text" data-v-47a7b6cf><span class="name" data-v-47a7b6cf>Federico Terzi</span> <span class="tagline" data-v-47a7b6cf>A Software Engineering Journey</span></div></div></a> <div class="extended-menu" data-v-47a7b6cf><a href="/#about" class="menu-link" data-v-47a7b6cf>About</a><a href="/projects" class="menu-link" data-v-47a7b6cf>Projects</a><a href="/blog" class="menu-link nuxt-link-active" data-v-47a7b6cf>Blog</a><a href="/talks" class="menu-link" data-v-47a7b6cf>Talks</a><a href="/contact-me" class="menu-link" data-v-47a7b6cf>Contact me</a></div> <div class="open-mobile-menu" data-v-47a7b6cf><svg width="26" height="18" viewBox="0 0 26 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-icon" data-v-47a7b6cf data-v-47a7b6cf><path d="M2 9.25H23.75" stroke="#C84C32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" data-v-47a7b6cf data-v-47a7b6cf></path><path d="M2 2H23.75" stroke="#C84C32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" data-v-47a7b6cf data-v-47a7b6cf></path><path d="M2 16.5H23.75" stroke="#C84C32" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" data-v-47a7b6cf data-v-47a7b6cf></path></svg></div> <!----></div></div> <div class="main-layout-content"><article data-v-c2aeccce><div class="short-page-container" data-v-c2aeccce><!----> <h1 class="post-title" data-v-c2aeccce>Understanding CRDTs: A Gentle Introduction (Chapter 1)</h1> <p class="post-details" data-v-c2aeccce>
      January 19th, 2024 - by Federico Terzi
    </p> <div class="post-content adaptive-images" data-v-c2aeccce><div class="nuxt-content" data-v-c2aeccce><blockquote data-v-c2aeccce>
<p data-v-c2aeccce>Welcome to <em data-v-c2aeccce>Understanding CRDTs</em>, a series of articles in which we’ll discuss CRDTs from the ground up. We’ll start from the basic concepts, trying to discuss different algorithms and data structures using simple JavaScript implementations, and we’ll gradually work towards a high-performance, JSON CRDT implementation written in Rust.</p>
<p data-v-c2aeccce>Chapters (so far):</p>
<ol data-v-c2aeccce>
<li data-v-c2aeccce><a href="/blog/understanding-crdts-a-gentle-introduction-chapter-1" aria-current="page" class="nuxt-link-exact-active nuxt-link-active" data-v-c2aeccce>A Gentle Introduction</a></li>
<li data-v-c2aeccce><a href="/blog/understanding-crdts-improving-our-set-chapter-2" data-v-c2aeccce>Improving our Set</a></li>
</ol>
</blockquote></div> <div class="nuxt-content" data-v-c2aeccce><p data-v-c2aeccce>In the past two months, I’ve been diving deeper into the realm of distributed systems. The catalyst that started my research was discovering the world of <a href="https://localfirstweb.dev/" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>local-first applications</a>, a class of software that allows users to access and modify their data locally, while seamlessly synchronizing across devices, even in the face of connection failures.</p>

<p data-v-c2aeccce>From the lens of distributed system theory, local-first applications could be defined as multi-master, eventually-consistent, distributed databases. A replica of the database would run on every user’s device, allowing writes at all times and, when a connection with another replica is available, synchronize the changes. Moreover, depending on the specific algorithm chosen to implement this distributed database, we could relax many of the topology constraints of traditional systems: imagine a system that could seamlessly synchronize across user devices (eg. P2P), while also <em data-v-c2aeccce>optionally</em> synchronizing with a central server.</p>
<p data-v-c2aeccce><img alt="An arbitrary network topology" src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image0.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>This architecture allows applications to offer a superb UX, allowing users to work even without an internet connection (eg. when flying on a plane or in the subway), without sacrificing the convenience of synchronization across devices, something that we take for granted nowadays. But if the UX is so much better for the end user, why do so many apps fail to implement such a model? For example, Notion, a very popular knowledge-base app, can’t work without an internet connection, leading to poor user experience in low-connectivity scenarios.</p>
<p data-v-c2aeccce>The answer is that implementing a robust multi-master replication is not trivial, and introduces several challenges. For example, what happens when two users write to the same entry concurrently?</p>
<p data-v-c2aeccce><img alt="Example of a concurrent write across different replicas." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image1.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>A traditional centralized database does not suffer from this problem, as all writes are handled by a single entity, which can decide with no ambiguity which update should take precedence.</p>
<p data-v-c2aeccce><img alt="The centralized database has the final say on what update has priority." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image2.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>But in a multi-master architecture, all replicas typically have the same priority, so how do we decide which update “win”?</p>
<p data-v-c2aeccce><img alt="In a multi-master scenario, dealing with conflicts is not trivial." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image3.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>A first approach could be to have the <em data-v-c2aeccce>last</em> update take precedence, a concept known as <em data-v-c2aeccce>Last Write Wins</em> (LWW): in this scenario, the last update being performed overwrites the previous one. So theoretically, we could just attach to each update a timestamp, and the update with the highest timestamp wins. Sounds easy, right?</p>
<p data-v-c2aeccce><img alt="Concurrent write in a multi-master scenario, with timestamps attached." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image4.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>Well, we have a problem, in fact, a serious problem: in a distributed system, clocks are never perfectly in sync. They can drift forward, backward, and even be completely off. And while most operating systems <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>will try their best to keep clocks in sync</a>, it’s not something we should rely on to guarantee correctness or integrity. Would you trust a database that 99.99% of the time works perfectly, but silently corrupts the data if the clock goes off?</p>
<p data-v-c2aeccce>And it gets worse, because even if clocks are perfectly in sync, the LWW semantic isn’t always appropriate. Imagine the scenario of a distributed counter: what happens if two replicas increment the counter concurrently? If we adopt the LWW semantic, one of the two increments is going to be lost.</p>
<p data-v-c2aeccce><img alt="We can’t represent a counter with an LWW semantic, as concurrent increments would be lost." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image5.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>It turns out that different use cases and data structures require different approaches to deal with conflicts. As you can imagine, this could get complex pretty quickly. Luckily for us, distributed system theory comes to the rescue with the concept of CRDT.</p>
<h1 id="introducing-crdts" data-v-c2aeccce><a href="#introducing-crdts" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Introducing CRDTs</h1>
<p data-v-c2aeccce><a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce><em data-v-c2aeccce>Conflict-free Replicated Data Types</em></a>, or CRDTs for short, are a class of data structures that can be replicated across nodes in a network, with the following features (quoting <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>Wikipedia</a>):</p>
<ol data-v-c2aeccce>
<li data-v-c2aeccce>The application can update any replica independently, <a href="https://en.wikipedia.org/wiki/Concurrent_computing" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>concurrently</a>, and without <a href="https://en.wikipedia.org/wiki/Concurrency_control" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>coordinating</a> with other replicas.</li>
<li data-v-c2aeccce>An algorithm (itself part of the data type) automatically resolves any inconsistencies that might occur.</li>
<li data-v-c2aeccce>Although replicas may have different state at any particular point in time, they are guaranteed to eventually converge.</li>
</ol>
<p data-v-c2aeccce>In other words, nodes can always access and modify their local copy of the CRDT as if it was a plain data structure (eg. a HashMap), and the CRDT algorithm takes care of conflict resolution and eventual convergence. It’s important to keep in mind that CRDTs do not require <a href="https://en.wikipedia.org/wiki/Consensus_(computer_science)" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>consensus</a> to operate: generally, there is no distinction between replicas in a CRDT, which contrasts with typical replicated databases, in which a particular node acts as a master, and others as read-only replicas.</p>
<p data-v-c2aeccce>The term <em data-v-c2aeccce>data structure</em> we used previously is purposefully generic: depending on the chosen approach, CRDTs can model widely different types of data structures: maps, lists, strings, trees, etc. So if you need a distributed data structure with the semantics of a HashMap, you can use a CRDT-based HashMap, and if you need to implement real-time text editing (eg. Google Docs) you can use a CRDT-based List of characters. Moreover, CRDTs can be composed nicely, so if you have a CRDT Map and a CRDT List, you can compose them to represent a JSON-like CRDT data structure, with nested objects and values.</p>
<p data-v-c2aeccce>Before diving into our first CRDT, it’s important to discuss the concept of <em data-v-c2aeccce>intent preservation</em>. We defined CRDTs as data structures that automatically resolve conflicts and eventually converge to the same value across replicas, but that’s only part of the picture. For example, we could think of a HashMap that never stores any value that is given to it:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-text" data-v-c2aeccce><code data-v-c2aeccce>class NoopMap {
  set(key, value) {
    // DO NOTHING
  }
  
  get(key) {
        return undefined;
  }
}
</code></pre></div>
<p data-v-c2aeccce>As crazy as it sounds, this data structure is a perfectly valid CRDT:</p>
<ul data-v-c2aeccce>
<li data-v-c2aeccce>Conflicts are automatically handled because no conflict can ever occur if we don’t store values</li>
<li data-v-c2aeccce>Every replica always converges to the same value, an empty map</li>
</ul>
<p data-v-c2aeccce>As you can imagine, despite being formally definable as a CRDT, this data structure is of little practical use. The reason is that in order for a CRDT algorithm to be <em data-v-c2aeccce>good</em> for practical purposes, it should try as much as possible to resolve conflicts while preserving the user’s intent, which has several important implications in our conflict resolution choices. We are going to cover this topic more in the following sections and chapters.</p>
<h1 id="our-first-crdt-set" data-v-c2aeccce><a href="#our-first-crdt-set" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Our first CRDT: Set</h1>
<p data-v-c2aeccce>Our CRDT adventure will start with a simple, yet very useful data structure: the Set.</p>
<p data-v-c2aeccce><img alt="A generic Set data structure." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image6.png" data-v-c2aeccce></p>
<h2 id="first-step-add-only-set" data-v-c2aeccce><a href="#first-step-add-only-set" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>First step: Add-only Set</h2>
<p data-v-c2aeccce>To make our lives easier, we’ll narrow down our goal at first by creating an <em data-v-c2aeccce>Add-only</em> Set, that is, a set to which we can add elements but not remove them (this is an important aspect, more on this later).</p>
<p data-v-c2aeccce>Our goal is to create a CRDT with the semantics of an Add-only Set. In simple terms, we want a data structure with these features:</p>
<ul data-v-c2aeccce>
<li data-v-c2aeccce>Elements can be added to the structure (<code data-v-c2aeccce>add</code> operation)</li>
<li data-v-c2aeccce>We can check if an element is present in the structure (<code data-v-c2aeccce>has</code> operation)</li>
<li data-v-c2aeccce>Elements are not ordered (Set semantics)</li>
<li data-v-c2aeccce>No duplicates (Set semantics)</li>
</ul>
<p data-v-c2aeccce>For these examples, we will use JavaScript as it’s popular enough to be understood by most people (although some might argue that no one <em data-v-c2aeccce>really</em> understands JavaScript /s).</p>
<p data-v-c2aeccce>Let’s start by implementing our <code data-v-c2aeccce>CRDTSet</code> class:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce><span class="token keyword" data-v-c2aeccce>class</span> <span class="token class-name" data-v-c2aeccce>CRDTAddOnlySet</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token function" data-v-c2aeccce>constructor</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>set</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>Set</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token function" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token function" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword control-flow" data-v-c2aeccce>return</span> <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>

<span class="token keyword" data-v-c2aeccce>const</span> set <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTAddOnlySet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>

set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'b'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'b'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'b'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>
</code></pre></div>
<p data-v-c2aeccce>Pretty straightforward so far: we created a <code data-v-c2aeccce>CRDTSet</code> class that wraps a Set and exposes the <code data-v-c2aeccce>add</code> and <code data-v-c2aeccce>has</code> operations.</p>
<p data-v-c2aeccce>Things start to get interesting when we introduce <code data-v-c2aeccce>CRDT</code> semantics, which we are going to cover in the next section.</p>
<h2 id="adding-crdt-semantics" data-v-c2aeccce><a href="#adding-crdt-semantics" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Adding CRDT semantics</h2>
<p data-v-c2aeccce>Our <code data-v-c2aeccce>CRDTAddOnlySet</code> currently lacks one of the most important features of a CRDT: convergence. In particular, we want every replica of our data structure to eventually converge to the same value.</p>
<p data-v-c2aeccce><img alt="Replicas eventually converge to the same Set value." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image7.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>At this point, we are not interested in the specific protocol used by different replicas to send each others’ changes. Let’s just assume that each replica will periodically send its <code data-v-c2aeccce>CRDTAddOnlySet</code> value to the other replicas.</p>
<p data-v-c2aeccce><img alt="Replicas sending to each other their entire values." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image8.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>To handle the merging process, we’ll add a new method to our <code data-v-c2aeccce>CRDTSet</code> structure: <code data-v-c2aeccce>merge</code>. This method takes another <code data-v-c2aeccce>CRDTAddOnlySet</code> and merges all its elements with the current set:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce><span class="token function" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>otherSet</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token keyword control-flow" data-v-c2aeccce>for</span> <span class="token punctuation" data-v-c2aeccce>(</span><span class="token keyword" data-v-c2aeccce>let</span> element <span class="token keyword" data-v-c2aeccce>of</span> otherSet<span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>With the <code data-v-c2aeccce>merge</code> method, we can now propagate changes among replicas. In this example, we propagate changes from replica B to replica A:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce><span class="token keyword" data-v-c2aeccce>const</span> replicaA <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTAddOnlySet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'b'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

<span class="token keyword" data-v-c2aeccce>const</span> replicaB <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTAddOnlySet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'b'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'b'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>

<span class="token comment" data-v-c2aeccce>// Here we propagate the changes from replica B to replica A</span>
replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'b'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>
</code></pre></div>
<p data-v-c2aeccce>Despite its simplicity, this approach offers some surprising advantages over traditional synchronization techniques:</p>
<ul data-v-c2aeccce>
<li data-v-c2aeccce>It’s highly <em data-v-c2aeccce>decentralized</em>: the algorithm imposes no constraint over the topology and communication between replicas. In particular, because the merging process is commutative and transitive, if replica A synchronizes with replica B, and then replica B synchronizes with replica C, then replica A and C will be in sync (as long as no concurrent update in A has happened in the meantime), despite having never communicated directly with each other.</li>
<li data-v-c2aeccce>As a result, the system is extremely robust against network problems and downtimes, as it can transparently make use of a <a href="https://en.wikipedia.org/wiki/Mesh_networking#:~:text=A%20mesh%20network%20is%20a,data%20to%20and%20from%20clients." rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>mesh network</a> rather than a traditional centralized solution.</li>
</ul>
<p data-v-c2aeccce>As you can imagine, there are downsides as well, which we’ll gradually cover in the following sections.</p>
<h2 id="adding-support-for-removals-a-naive-αttempt" data-v-c2aeccce><a href="#adding-support-for-removals-a-naive-%CE%B1ttempt" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Adding support for Removals: a Naive Αttempt</h2>
<p data-v-c2aeccce>Although an Add-only Set could be useful in some cases, many scenarios would also require removal operations, so our next goal is to add support for them. In short, we want to introduce a <code data-v-c2aeccce>remove</code> method that replicas can use to remove an element from the Set.</p>
<p data-v-c2aeccce>A first attempt could look as follows:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce><span class="token function" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>set</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>delete</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>And if we try to run it:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce><span class="token keyword" data-v-c2aeccce>const</span> set <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>
set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>set<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>
</code></pre></div>
<p data-v-c2aeccce>It works! Wait… does it? Apparently, the remove operation works correctly, but what happens when we synchronize the set across multiple replicas?</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce><span class="token keyword" data-v-c2aeccce>const</span> replicaA <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>

<span class="token keyword" data-v-c2aeccce>const</span> replicaB <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>       <span class="token comment" data-v-c2aeccce>// Sync replica B with replica A</span>

replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>       <span class="token comment" data-v-c2aeccce>// Sync replica A with replica B</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true!!! The 'a' came back!</span>
</code></pre></div>
<p data-v-c2aeccce>We have a problem: although replica A deleted element <code data-v-c2aeccce>a</code>, synchronizing with replica B causes the <code data-v-c2aeccce>a</code> element to come back!</p>
<p data-v-c2aeccce><img alt="After the second synchronization, the “a” element is undeleted from replica A, which is not the expected behavior." src="/posts/2024-01-19-understanding-crdts-a-gentle-introduction-chapter-1/image9.png" data-v-c2aeccce></p>
<p data-v-c2aeccce>Our <code data-v-c2aeccce>remove</code> operation is quite flaky: depending on the synchronization sequence, elements can be randomly undeleted. How can we solve this problem?</p>
<p data-v-c2aeccce>Turns out that delete operations are one of the core complexities of CRDTs, and multiple approaches exist to deal with them. Each has its own set of tradeoffs, so we’ll discuss some of them in the upcoming sections.</p>
<h2 id="adding-support-for-removals-the-set-pair-approach" data-v-c2aeccce><a href="#adding-support-for-removals-the-set-pair-approach" aria-hidden="true" tabindex="-1" data-v-c2aeccce><span class="icon icon-link" data-v-c2aeccce></span></a>Adding support for Removals: the Set-pair Approach</h2>
<p data-v-c2aeccce>A first approach to deal with removals is the Set-pair technique. In a nutshell, instead of using a Set to represent the elements, we are going to use <em data-v-c2aeccce>two</em>: one for the additions and one for the removals. It might seem confusing at first, so let’s try to take it step by step.</p>
<p data-v-c2aeccce>Let’s start with an empty set, which will be represented internally by two add-only sets:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>Then, we add elements <code data-v-c2aeccce>a</code> and <code data-v-c2aeccce>b</code>:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>a<span class="token punctuation" data-v-c2aeccce>,</span> b<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span><span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>If we now want to remove <code data-v-c2aeccce>b</code>, we could try deleting it directly from the <code data-v-c2aeccce>elements</code> set, but we would then experience the same flakiness problem saw previously. Instead, we are going to <em data-v-c2aeccce>add</em> the <code data-v-c2aeccce>b</code> element to the <code data-v-c2aeccce>removals</code> set:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce>elements <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>a<span class="token punctuation" data-v-c2aeccce>,</span> b<span class="token punctuation" data-v-c2aeccce>}</span>
removals <span class="token operator" data-v-c2aeccce>=</span> <span class="token punctuation" data-v-c2aeccce>{</span>b<span class="token punctuation" data-v-c2aeccce>}</span>
</code></pre></div>
<p data-v-c2aeccce>We can now define the content of the Set as:</p>
<blockquote data-v-c2aeccce>
<p data-v-c2aeccce>All the elements in the <code data-v-c2aeccce>elements</code> Set that are not present in the <code data-v-c2aeccce>removals</code> Set.</p>
</blockquote>
<p data-v-c2aeccce>We can implement this Set by elegantly composing two <code data-v-c2aeccce>CRDTAddOnlySet</code> together:</p>
<div class="nuxt-content-highlight" data-v-c2aeccce><pre class="line-numbers language-javascript" data-v-c2aeccce><code data-v-c2aeccce><span class="token keyword" data-v-c2aeccce>class</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span> <span class="token punctuation" data-v-c2aeccce>{</span>
    <span class="token function" data-v-c2aeccce>constructor</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTAddOnlySet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span> <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTAddOnlySet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token function" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token function" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword control-flow" data-v-c2aeccce>if</span> <span class="token punctuation" data-v-c2aeccce>(</span><span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
            <span class="token keyword control-flow" data-v-c2aeccce>return</span> <span class="token boolean" data-v-c2aeccce>false</span><span class="token punctuation" data-v-c2aeccce>;</span>
        <span class="token punctuation" data-v-c2aeccce>}</span>

        <span class="token keyword control-flow" data-v-c2aeccce>return</span> <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token function" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>element</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span>element<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>

    <span class="token function" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token parameter" data-v-c2aeccce>otherSet</span><span class="token punctuation" data-v-c2aeccce>)</span> <span class="token punctuation" data-v-c2aeccce>{</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>otherSet<span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>elements</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
        <span class="token keyword" data-v-c2aeccce>this</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>otherSet<span class="token punctuation" data-v-c2aeccce>.</span><span class="token property-access" data-v-c2aeccce>removals</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
    <span class="token punctuation" data-v-c2aeccce>}</span>
<span class="token punctuation" data-v-c2aeccce>}</span>

<span class="token keyword" data-v-c2aeccce>const</span> replicaA <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>add</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// true</span>

<span class="token keyword" data-v-c2aeccce>const</span> replicaB <span class="token operator" data-v-c2aeccce>=</span> <span class="token keyword" data-v-c2aeccce>new</span> <span class="token class-name" data-v-c2aeccce>CRDTSet</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
replicaB<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>

replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>remove</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false</span>

replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>merge</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaB<span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span>
<span class="token console class-name" data-v-c2aeccce>console</span><span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>log</span><span class="token punctuation" data-v-c2aeccce>(</span>replicaA<span class="token punctuation" data-v-c2aeccce>.</span><span class="token method function property-access" data-v-c2aeccce>has</span><span class="token punctuation" data-v-c2aeccce>(</span><span class="token string" data-v-c2aeccce>'a'</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>)</span><span class="token punctuation" data-v-c2aeccce>;</span> <span class="token comment" data-v-c2aeccce>// false (still false, yey!)</span>
</code></pre></div>
<p data-v-c2aeccce>As you can see, our new Set remembers the removed element <code data-v-c2aeccce>a</code> even after a synchronization!</p>
<p data-v-c2aeccce>Unfortunately, our current <code data-v-c2aeccce>CRDTSet</code> still has some problems:</p>
<ol data-v-c2aeccce>
<li data-v-c2aeccce>What happens if a replica adds an element after removing it? With the current implementation, once an element has been removed it won’t be restorable.</li>
<li data-v-c2aeccce>Although we are <em data-v-c2aeccce>logically</em> removing elements, the size of our data structure keeps increasing over time. If we perform many removals, that would bloat our memory consumption significantly.</li>
</ol>
<p data-v-c2aeccce>In the <a href="/blog/understanding-crdts-improving-our-set-chapter-2" data-v-c2aeccce>next chapter</a>, we are going to answer these two questions and more, so stay tuned!</p>
<p data-v-c2aeccce>PS: All the code is available in this repository: <a href="https://github.com/federico-terzi/crdt-experiments" rel="nofollow noopener noreferrer" target="_blank" data-v-c2aeccce>https://github.com/federico-terzi/crdt-experiments</a></p></div></div> <div class="post-footer-container post-footer" data-v-63505c64 data-v-c2aeccce><img src="/_nuxt/img/profile-picture-small.40e71b2.png" alt="Federico Terzi Picture" class="post-footer-image" data-v-63505c64> <div class="post-footer-content" data-v-63505c64><p data-v-63505c64>Hi 👋, I’m <span class="red" data-v-63505c64>Federico</span>, thanks for reading!</p> <p data-v-63505c64>
      If you liked this article, make sure to follow me on
      <a href="https://twitter.com/terzi_federico" class="blue" data-v-63505c64>Twitter</a> to
      stay updated with the latest ones :)
    </p> <p data-v-63505c64>
      If you are into technical topics, you might also enjoy my
      <a href="https://www.youtube.com/c/FedericoTerzi" class="red" data-v-63505c64>YouTube</a>
      channel.
    </p></div></div></div></article></div> <div class="footer-container" data-v-d5d2bd86><p data-v-d5d2bd86><span class="bold" data-v-d5d2bd86>Designed</span> and
    <span class="bold" data-v-d5d2bd86>coded</span> with<span class="red" data-v-d5d2bd86> ♥</span> by me.
    Copyright © Federico Terzi 2019-2024 - P.IVA 03864201201
  </p></div> <div class="social-bar-container"><a href="https://twitter.com/terzi_federico"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23 3.00005C22.0424 3.67552 20.9821 4.19216 19.86 4.53005C19.2577 3.83756 18.4573 3.34674 17.567 3.12397C16.6767 2.90121 15.7395 2.95724 14.8821 3.2845C14.0247 3.61176 13.2884 4.19445 12.773 4.95376C12.2575 5.71308 11.9877 6.61238 12 7.53005V8.53005C10.2426 8.57561 8.50127 8.18586 6.93101 7.39549C5.36074 6.60513 4.01032 5.43868 3 4.00005C3 4.00005 -1 13 8 17C5.94053 18.398 3.48716 19.099 1 19C10 24 21 19 21 7.50005C20.9991 7.2215 20.9723 6.94364 20.92 6.67005C21.9406 5.66354 22.6608 4.39276 23 3.00005V3.00005Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></a> <div class="social-bar-divider"></div> <a href="https://github.com/federico-terzi/"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_31_53)"><path d="M16 21.9999V18.1299C16.0375 17.6531 15.9731 17.1737 15.811 16.7237C15.6489 16.2737 15.3929 15.8634 15.06 15.5199C18.2 15.1699 21.5 13.9799 21.5 8.51994C21.4997 7.12376 20.9627 5.78114 20 4.76994C20.4559 3.54844 20.4236 2.19829 19.91 0.999938C19.91 0.999938 18.73 0.649938 16 2.47994C13.708 1.85876 11.292 1.85876 9 2.47994C6.27 0.649938 5.09 0.999938 5.09 0.999938C4.57638 2.19829 4.54414 3.54844 5 4.76994C4.03013 5.78864 3.49252 7.1434 3.5 8.54994C3.5 13.9699 6.8 15.1599 9.94 15.5499C9.611 15.8899 9.35726 16.2953 9.19531 16.7399C9.03335 17.1844 8.96681 17.658 9 18.1299V21.9999M9 18.9999C4 20.4999 4 16.4999 2 15.9999L9 18.9999Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0_31_53"><rect width="24" height="24" fill="white"></rect></clipPath></defs></svg></a> <div class="social-bar-divider"></div> <a href="https://www.linkedin.com/in/federico-terzi/"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 8C17.5913 8 19.1174 8.63214 20.2426 9.75736C21.3679 10.8826 22 12.4087 22 14V21H18V14C18 13.4696 17.7893 12.9609 17.4142 12.5858C17.0391 12.2107 16.5304 12 16 12C15.4696 12 14.9609 12.2107 14.5858 12.5858C14.2107 12.9609 14 13.4696 14 14V21H10V14C10 12.4087 10.6321 10.8826 11.7574 9.75736C12.8826 8.63214 14.4087 8 16 8V8Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6 9H2V21H6V9Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 6C5.10457 6 6 5.10457 6 4C6 2.89543 5.10457 2 4 2C2.89543 2 2 2.89543 2 4C2 5.10457 2.89543 6 4 6Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></a> <div class="social-bar-divider"></div> <a href="https://www.youtube.com/c/FedericoTerzi"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.54 6.42C22.4212 5.94541 22.1793 5.51057 21.8387 5.15941C21.498 4.80824 21.0708 4.55318 20.6 4.42C18.88 4 12 4 12 4C12 4 5.12001 4 3.40001 4.46C2.92925 4.59318 2.50198 4.84824 2.16135 5.19941C1.82072 5.55057 1.5788 5.98541 1.46001 6.46C1.14522 8.20556 0.991243 9.97631 1.00001 11.75C0.988786 13.537 1.14277 15.3213 1.46001 17.08C1.59097 17.5398 1.83831 17.9581 2.17815 18.2945C2.51799 18.6308 2.93883 18.8738 3.40001 19C5.12001 19.46 12 19.46 12 19.46C12 19.46 18.88 19.46 20.6 19C21.0708 18.8668 21.498 18.6118 21.8387 18.2606C22.1793 17.9094 22.4212 17.4746 22.54 17C22.8524 15.2676 23.0063 13.5103 23 11.75C23.0112 9.96295 22.8572 8.1787 22.54 6.42V6.42Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M9.75 15.02L15.5 11.75L9.75 8.47998V15.02Z" stroke="#2E4364" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></a></div></div></div></div><script defer src="/_nuxt/static/1712253390/blog/understanding-crdts-a-gentle-introduction-chapter-1/state.js"></script><script src="/_nuxt/4aae9c2.js" defer></script><script src="/_nuxt/f5ea8a1.js" defer></script><script src="/_nuxt/17ba505.js" defer></script><script src="/_nuxt/4293a24.js" defer></script><script src="/_nuxt/cd10c32.js" defer></script>
  </body>
</html>
